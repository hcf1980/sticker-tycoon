# 🔄 張數制度改革執行方案

## 📋 改革概述

### 現有制度問題
- ❌ 張數（token）作為虛擬貨幣容易讓用戶混淆
- ❌ 計價方式複雜（6張=3張數，不直觀）
- ❌ 用戶不清楚張數與實際張數的對應關係

### 新制度優勢
- ✅ **直觀明確**：購買「張數」直接對應生成張數
- ✅ **簡化計價**：1張=1單位，容易理解
- ✅ **透明消費**：用戶清楚知道每次消耗多少張數

---

## 💰 新張數（張數）制度

### 1. 商品定價（以「張數」為單位）

| 商品名稱 | 張數 | 價格 | 單價 |
|---------|------|------|------|
| 基礎包 | 140 張 | NT$ 300 | 2.14 元/張 |
| 超值包 | 260 張 | NT$ 500 | 1.92 元/張 |

### 2. 張數消耗規則

#### 生成服務
- **生成 1 張貼圖** = 扣除 **1 張**
- **生成 6 張貼圖** = 扣除 **6 張**
- **生成 12 張貼圖** = 扣除 **12 張**
- **生成 40 張貼圖** = 扣除 **40 張**

#### 附加服務
- **下載服務**（打包 ZIP）= 扣除 **60 張**
- **下載 + 代上架**（協助上架 LINE Store；代上架服務免費，張數用於貼圖製作與整理流程）= 扣除 **60 張**

### 3. 新用戶福利
- 🎁 新用戶註冊贈送：**40 張**（舊用戶張數直接轉換為張數）
- 👥 推薦好友獎勵：推薦人與被推薦人各得 **10 張**（上限 30 次）

---

## 🔧 技術實施方案

### Phase 1: 資料庫遷移（不影響現有用戶）

#### 1.1 欄位重命名（語義層面）
```sql
-- users 表：sticker_credits 欄位保持不變，但語義改為「張數」
COMMENT ON COLUMN users.sticker_credits IS '可用張數（原為張數，現改為貼圖張數）';

-- token_ledger 表：欄位名稱保持，但語義改為「張數」
COMMENT ON TABLE token_ledger IS '張數帳本表（追蹤每筆張數的有效期和剩餘數量）';
COMMENT ON COLUMN token_ledger.tokens IS '該筆張數的原始數量（原為張數）';
COMMENT ON COLUMN token_ledger.remaining_tokens IS '該筆張數的剩餘可用數量';

-- token_transactions 表：保持不變
COMMENT ON TABLE token_transactions IS '張數交易記錄表（原為張數交易）';
```

#### 1.2 現有用戶數據轉換
```sql
-- 📌 策略：現有張數數直接轉換為張數（1:1 對應）
-- 舉例：用戶有 40 張數 → 轉換後有 40 張
-- 無需執行任何 UPDATE，數值保持不變，僅改變語義
```

**轉換邏輯說明**：
- 原有 40 張數 = 現在 40 張
- 原有 70 張數 = 現在 70 張
- 原有 130 張數 = 現在 130 張

**優勢**：
✅ 無需修改任何數值
✅ 不影響現有用戶餘額
✅ 無需停機維護

---

### Phase 2: 程式碼調整

#### 2.1 需要修改的檔案清單

##### 核心邏輯檔案（張數扣除）
1. `functions/supabase-client.js`
   - `deductTokens()` → 改為 `deductStickers()` 或保持函數名但更新註解
   - 更新扣除邏輯：1張貼圖 = 扣除1單位

2. `functions/sticker-generator-worker-background.js`
   - 修改 `tokenCost` 計算邏輯
   - 舊：`Math.ceil(count / 6) * 3`（每6張=3張數）
   - 新：`count`（生成幾張就扣幾張）

3. `functions/pack-for-line.js`
   - 修改 `DOWNLOAD_COST = 40` → `DOWNLOAD_COST = 60`

4. `functions/grid-generator.js`
   - 修改 `GRID_CONFIG.tokensPerBatch`
   - 舊：每6張 = 3張數
   - 新：每6張 = 6張數

##### 使用者介面檔案（顯示文字）
5. `public/token-guide.html` - 購買說明頁面
6. `public/token-guide-mobile.html` - 手機版購買說明
7. `public/queue.html` - 佇列管理頁面（下載提示）
8. `README.md` - 專案說明文件

##### 文檔檔案
9. `docs/api/LINE_PAY_INTEGRATION_GUIDE.md`
10. `docs/TOKEN_SYSTEM_STATUS.md`

##### LINE Bot 回覆訊息
11. `functions/services/command-service.js` - 張數查詢命令
12. `functions/handlers/*` - 各種對話處理器

---

### Phase 3: 文案更新範圍

#### 3.1 全站文案替換規則

| 舊文案 | 新文案 |
|--------|--------|
| 張數 | 張數 / 張 |
| token / tokens | stickers / sheets |
| 💰 | 🎫 |
| 張數餘額 | 剩餘張數 |
| 購買張數 | 購買張數 |
| 張數不足 | 張數不足 |
| 消耗 X 張數 | 消耗 X 張 |
| 扣除 X 張數 | 扣除 X 張 |

#### 3.2 關鍵頁面文案示例

**購買方案頁面**（token-guide.html）：
```
舊：基礎包 - 70 張數 - NT$ 300
新：基礎包 - 140 張 - NT$ 300

舊：生成 6 張貼圖 = 3 張數
新：生成 6 張貼圖 = 6 張

舊：下載服務 = 40 張數
新：下載服務 = 60 張
```

**LINE Bot 回覆訊息**：
```
舊：💰 您的張數餘額：40 張數
新：🎫 您的剩餘張數：40 張

舊：❌ 張數不足！需要 3 張數，您只有 1 張數
新：❌ 張數不足！需要 6 張，您只有 1 張
```

---

## ✅ 執行檢查清單

### 階段 1：準備階段（1 天）
- [ ] 備份 Supabase 資料庫
- [ ] 在測試環境部署並測試
- [ ] 確認現有用戶數據轉換策略

### 階段 2：程式碼修改（2-3 天）
- [ ] 修改核心扣除邏輯（5 個檔案）
- [ ] 更新使用者介面文案（3 個 HTML 檔案）
- [ ] 更新文檔檔案（3 個 MD 檔案）
- [ ] 更新 LINE Bot 回覆訊息（2 個 JS 檔案）
- [ ] 執行單元測試

### 階段 3：部署與監控（1 天）
- [ ] 部署到 Netlify
- [ ] 監控錯誤日誌
- [ ] 測試購買流程
- [ ] 測試生成/下載流程
- [ ] 向現有用戶發送通知

---

## ⚠️ 風險評估與應對

### 潛在風險
1. **用戶混淆**：舊用戶可能不適應新名稱
   - **應對**：發送系統通知說明變更
   
2. **程式錯誤**：扣除邏輯修改可能導致錯誤
   - **應對**：充分測試，灰度發布

3. **歷史資料**：舊交易記錄顯示「張數」
   - **應對**：保持歷史記錄不變，僅更新新記錄

---

## 📊 結論

✅ **此改革方案可執行**
- 技術上可行，無需停機
- 用戶數據無需遷移（1:1 對應）
- 僅需修改約 15 個檔案
- 預估完成時間：3-5 個工作天

✅ **優勢明顯**
- 用戶體驗更直觀
- 計價方式更透明
- 降低客服成本

