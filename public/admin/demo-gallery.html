<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¤ºç¯„åœ–é›†ç®¡ç† - è²¼åœ–å¤§äº¨</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-gradient-to-r from-pink-500 to-orange-400 text-white p-4">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">âœ¨ ç¤ºç¯„åœ–é›†ç®¡ç†</h1>
      <a href="/admin/" class="text-white hover:underline">â† è¿”å›å¾Œå°</a>
    </div>
  </nav>

  <div class="container mx-auto p-6">
    <!-- åŠŸèƒ½é¸é …å¡ -->
    <div class="bg-white rounded-lg shadow mb-6">
      <div class="flex border-b">
        <button class="tab-btn px-6 py-3 font-semibold border-b-2 border-pink-500 text-pink-500" data-tab="browse">
          ğŸ” ç€è¦½å·²ç”Ÿæˆè²¼åœ–
        </button>
        <button class="tab-btn px-6 py-3 font-semibold text-gray-500 hover:text-pink-500" data-tab="demo">
          âœ¨ ç•¶å‰ç¤ºç¯„åœ–é›†
        </button>
      </div>
    </div>

    <!-- ç€è¦½å·²ç”Ÿæˆè²¼åœ– -->
    <div id="tab-browse" class="tab-content">
      <!-- ç¯©é¸å™¨ -->
      <div class="bg-white rounded-lg shadow p-4 mb-6">
        <div class="grid md:grid-cols-4 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">é¢¨æ ¼</label>
            <select id="filterStyle" class="w-full border rounded px-3 py-2">
              <option value="">å…¨éƒ¨é¢¨æ ¼</option>
              <option value="realistic">ğŸ“¸ ç¾é¡çœŸå¯¦</option>
              <option value="cute">ğŸ¥° å¯æ„›é¢¨</option>
              <option value="cool">ğŸ˜ é…·ç‚«é¢¨</option>
              <option value="funny">ğŸ¤£ æç¬‘é¢¨</option>
              <option value="simple">âœ¨ ç°¡ç´„é¢¨</option>
              <option value="anime">ğŸŒ å‹•æ¼«é¢¨</option>
              <option value="pixel">ğŸ‘¾ åƒç´ é¢¨</option>
              <option value="sketch">âœï¸ å¡—é´‰é¢¨</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ç‹€æ…‹</label>
            <select id="filterStatus" class="w-full border rounded px-3 py-2">
              <option value="completed">å·²å®Œæˆ</option>
              <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">æ’åº</label>
            <select id="sortBy" class="w-full border rounded px-3 py-2">
              <option value="created_desc">æœ€æ–°å„ªå…ˆ</option>
              <option value="created_asc">æœ€èˆŠå„ªå…ˆ</option>
            </select>
          </div>
          <div class="flex items-end">
            <button id="btnApplyFilter" class="w-full bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600">
              ğŸ” å¥—ç”¨ç¯©é¸
            </button>
          </div>
        </div>
      </div>

      <!-- è²¼åœ–åˆ—è¡¨ -->
      <div id="stickerSets" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="text-center text-gray-500 col-span-full py-10">
          è¼‰å…¥ä¸­...
        </div>
      </div>

      <!-- åˆ†é  -->
      <div id="pagination" class="mt-6 flex justify-center gap-2"></div>
    </div>

    <!-- ç•¶å‰ç¤ºç¯„åœ–é›† -->
    <div id="tab-demo" class="tab-content hidden">
      <div class="bg-white rounded-lg shadow p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold">ç•¶å‰ç¤ºç¯„åœ–é›†</h3>
          <button id="btnSaveDemo" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            ğŸ’¾ å„²å­˜è®Šæ›´
          </button>
        </div>
        <div id="currentDemo" class="grid md:grid-cols-3 lg:grid-cols-4 gap-4">
          <div class="text-center text-gray-500 col-span-full py-10">
            è¼‰å…¥ä¸­...
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- è²¼åœ–è©³æƒ…å½ˆçª— -->
  <div id="stickerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
      <div class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-bold">è²¼åœ–è©³æƒ…</h3>
          <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        <div id="modalContent"></div>
      </div>
    </div>
  </div>

  <script>
    // é©—è­‰ç™»å…¥
    function checkAuth() {
      const auth = JSON.parse(localStorage.getItem('adminAuth') || '{}');
      if (!auth.loggedIn || auth.expiry < Date.now()) {
        window.location.href = '/admin/login.html';
        return false;
      }
      return true;
    }
    
    if (!checkAuth()) {
      document.body.innerHTML = '<div class="text-center p-10">è·³è½‰ä¸­...</div>';
    }

    let currentPage = 1;
    let currentData = [];
    let demoGallery = [];

    // é¸é …å¡åˆ‡æ›
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const tab = this.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.remove('border-pink-500', 'text-pink-500');
          b.classList.add('text-gray-500');
        });
        this.classList.add('border-pink-500', 'text-pink-500');
        this.classList.remove('text-gray-500');
        
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
        
        if (tab === 'demo') loadDemoGallery();
      });
    });

    // è¼‰å…¥è²¼åœ–åˆ—è¡¨
    async function loadStickerSets() {
      try {
        const style = document.getElementById('filterStyle').value;
        const status = document.getElementById('filterStatus').value;
        const sort = document.getElementById('sortBy').value;

        const response = await fetch(`/.netlify/functions/admin-stickers?page=${currentPage}&style=${style}&status=${status}&sort=${sort}`);
        if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

        const data = await response.json();
        currentData = data.sets || [];

        renderStickerSets(currentData);
        renderPagination(data.total, data.perPage);
      } catch (error) {
        document.getElementById('stickerSets').innerHTML = `
          <div class="col-span-full text-center text-red-500 py-10">
            è¼‰å…¥å¤±æ•—: ${error.message}
          </div>
        `;
      }
    }

    // æ¸²æŸ“è²¼åœ–åˆ—è¡¨
    function renderStickerSets(sets) {
      const container = document.getElementById('stickerSets');
      if (sets.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">æ²’æœ‰æ‰¾åˆ°è²¼åœ–</div>';
        return;
      }

      container.innerHTML = sets.map(set => `
        <div class="bg-white rounded-lg shadow overflow-hidden hover:shadow-lg transition">
          <div class="aspect-square bg-gray-100 relative">
            ${set.main_image_url ? `
              <img src="${set.main_image_url}" alt="${set.name}" class="w-full h-full object-cover">
            ` : `
              <div class="flex items-center justify-center h-full text-gray-400">ç„¡é è¦½</div>
            `}
          </div>
          <div class="p-4">
            <h4 class="font-bold text-lg mb-2 truncate">${set.name || 'æœªå‘½å'}</h4>
            <div class="text-sm text-gray-600 space-y-1">
              <div>ğŸ“Š ${set.sticker_count || 0} å¼µè²¼åœ–</div>
              <div>ğŸ¨ ${getStyleName(set.style)}</div>
              <div>ğŸ‘¤ ${set.character_description || 'æœªæŒ‡å®š'}</div>
            </div>
            <button onclick="viewSetDetails('${set.set_id || set.id}')"
                    class="mt-4 w-full bg-pink-500 text-white py-2 rounded hover:bg-pink-600">
              æŸ¥çœ‹è©³æƒ…
            </button>
          </div>
        </div>
      `).join('');
    }

    // æŸ¥çœ‹è²¼åœ–çµ„è©³æƒ…
    async function viewSetDetails(setId) {
      try {
        const response = await fetch(`/.netlify/functions/admin-stickers?setId=${setId}`);
        if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

        const data = await response.json();
        showStickerModal(data);
      } catch (error) {
        alert('è¼‰å…¥å¤±æ•—: ' + error.message);
      }
    }

    // é¡¯ç¤ºè²¼åœ–å½ˆçª—
    function showStickerModal(data) {
      const modal = document.getElementById('stickerModal');
      const content = document.getElementById('modalContent');

      content.innerHTML = `
        <div class="mb-6">
          <h4 class="text-xl font-bold mb-4">${data.set.name || 'æœªå‘½å'}</h4>
          <div class="grid md:grid-cols-2 gap-4 text-sm">
            <div><strong>é¢¨æ ¼ï¼š</strong>${getStyleName(data.set.style)}</div>
            <div><strong>å¼µæ•¸ï¼š</strong>${data.set.sticker_count || 0} å¼µ</div>
            <div><strong>è§’è‰²æè¿°ï¼š</strong>${data.set.character_description || 'æœªæŒ‡å®š'}</div>
            <div><strong>å ´æ™¯ï¼š</strong>${data.set.scene || 'æœªæŒ‡å®š'}</div>
            <div class="md:col-span-2"><strong>è¡¨æƒ…æ¨¡æ¿ï¼š</strong>${data.set.expression_template || 'æœªæŒ‡å®š'}</div>
          </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          ${(data.images || []).map((img, idx) => `
            <div class="relative group">
              <img src="${img.image_url}" alt="è²¼åœ– ${idx + 1}" class="w-full aspect-square object-cover rounded border">
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 transition flex items-center justify-center">
                <button onclick="addToDemo('${data.set.set_id || data.set.id}', ${idx}, '${img.image_url}')"
                        class="opacity-0 group-hover:opacity-100 bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-600">
                  â• åŠ å…¥ç¤ºç¯„åœ–é›†
                </button>
              </div>
              ${img.expression ? `<div class="mt-1 text-xs text-center text-gray-600">${img.expression}</div>` : ''}
            </div>
          `).join('')}
        </div>
      `;

      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    // åŠ å…¥ç¤ºç¯„åœ–é›†
    function addToDemo(setId, index, imageUrl) {
      // ç²å–è²¼åœ–çš„å®Œæ•´è³‡è¨Š
      const set = currentData.find(s => (s.set_id || s.id) === setId);
      if (!set) return;

      const demoItem = {
        url: imageUrl,
        style: set.style,
        styleName: getStyleName(set.style),
        character: set.character_description,
        scene: set.scene,
        expression: set.expression_template,
        setId: setId,
        index: index
      };

      // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
      if (demoGallery.some(item => item.url === imageUrl)) {
        alert('æ­¤åœ–ç‰‡å·²åœ¨ç¤ºç¯„åœ–é›†ä¸­');
        return;
      }

      demoGallery.push(demoItem);
      alert('å·²åŠ å…¥ç¤ºç¯„åœ–é›†ï¼');

      // å¦‚æœåœ¨ç¤ºç¯„åœ–é›†é é¢ï¼Œæ›´æ–°é¡¯ç¤º
      if (!document.getElementById('tab-demo').classList.contains('hidden')) {
        renderDemoGallery();
      }
    }

    // è¼‰å…¥ç•¶å‰ç¤ºç¯„åœ–é›†
    async function loadDemoGallery() {
      try {
        const response = await fetch('/.netlify/functions/demo-gallery');
        if (response.ok) {
          const data = await response.json();
          demoGallery = data.items || [];
          renderDemoGallery();
        }
      } catch (error) {
        console.error('è¼‰å…¥ç¤ºç¯„åœ–é›†å¤±æ•—:', error);
      }
    }

    // æ¸²æŸ“ç¤ºç¯„åœ–é›†
    function renderDemoGallery() {
      const container = document.getElementById('currentDemo');
      if (demoGallery.length === 0) {
        container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">å°šæœªæ·»åŠ ä»»ä½•ç¤ºç¯„åœ–ç‰‡</div>';
        return;
      }

      container.innerHTML = demoGallery.map((item, idx) => `
        <div class="bg-white border-2 border-pink-200 rounded-lg p-3">
          <div class="relative group">
            <img src="${item.url}" alt="ç¤ºç¯„ ${idx + 1}" class="w-full aspect-square object-cover rounded mb-2">
            <button onclick="removeFromDemo(${idx})"
                    class="absolute top-2 right-2 bg-red-500 text-white w-8 h-8 rounded-full opacity-0 group-hover:opacity-100 transition">
              âœ•
            </button>
          </div>
          <div class="text-xs space-y-1">
            <div class="font-bold text-pink-600">ğŸ¨ ${item.styleName}</div>
            ${item.character ? `<div>ğŸ‘¤ ${truncate(item.character, 30)}</div>` : ''}
            ${item.scene ? `<div>ğŸŒ„ ${truncate(item.scene, 30)}</div>` : ''}
            ${item.expression ? `<div>ğŸ˜Š ${truncate(item.expression, 30)}</div>` : ''}
          </div>
        </div>
      `).join('');
    }

    // å¾ç¤ºç¯„åœ–é›†ç§»é™¤
    function removeFromDemo(index) {
      if (confirm('ç¢ºå®šè¦ç§»é™¤æ­¤åœ–ç‰‡ï¼Ÿ')) {
        demoGallery.splice(index, 1);
        renderDemoGallery();
      }
    }

    // å„²å­˜ç¤ºç¯„åœ–é›†
    async function saveDemoGallery() {
      try {
        const btn = document.getElementById('btnSaveDemo');
        btn.disabled = true;
        btn.textContent = 'å„²å­˜ä¸­...';

        const response = await fetch('/.netlify/functions/demo-gallery', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: demoGallery })
        });

        if (!response.ok) throw new Error('å„²å­˜å¤±æ•—');

        alert('âœ… ç¤ºç¯„åœ–é›†å·²å„²å­˜ï¼');
      } catch (error) {
        alert('âŒ å„²å­˜å¤±æ•—: ' + error.message);
      } finally {
        const btn = document.getElementById('btnSaveDemo');
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ å„²å­˜è®Šæ›´';
      }
    }

    // åˆ†é æ¸²æŸ“
    function renderPagination(total, perPage) {
      const totalPages = Math.ceil(total / perPage);
      const container = document.getElementById('pagination');

      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '';
      for (let i = 1; i <= totalPages; i++) {
        html += `
          <button onclick="currentPage = ${i}; loadStickerSets();"
                  class="px-4 py-2 rounded ${i === currentPage ? 'bg-pink-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-100'}">
            ${i}
          </button>
        `;
      }

      container.innerHTML = html;
    }

    // å·¥å…·å‡½æ•¸
    function getStyleName(style) {
      const styles = {
        'realistic': 'ğŸ“¸ ç¾é¡çœŸå¯¦',
        'cute': 'ğŸ¥° å¯æ„›é¢¨',
        'cool': 'ğŸ˜ é…·ç‚«é¢¨',
        'funny': 'ğŸ¤£ æç¬‘é¢¨',
        'simple': 'âœ¨ ç°¡ç´„é¢¨',
        'anime': 'ğŸŒ å‹•æ¼«é¢¨',
        'pixel': 'ğŸ‘¾ åƒç´ é¢¨',
        'sketch': 'âœï¸ å¡—é´‰é¢¨'
      };
      return styles[style] || style || 'æœªæŒ‡å®š';
    }

    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.substring(0, len) + '...' : str;
    }

    // äº‹ä»¶ç›£è½
    document.getElementById('btnApplyFilter').addEventListener('click', () => {
      currentPage = 1;
      loadStickerSets();
    });

    document.getElementById('btnSaveDemo').addEventListener('click', saveDemoGallery);

    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('stickerModal').classList.add('hidden');
      document.getElementById('stickerModal').classList.remove('flex');
    });

    // åˆå§‹åŒ–
    loadStickerSets();
    loadDemoGallery();
  </script>
</body>
</html>

