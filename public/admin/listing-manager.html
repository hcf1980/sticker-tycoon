<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸Šæ¶ç”³è«‹ç®¡ç† - è²¼åœ–å¤§äº¨</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .status-pending { background: #fff3e0; color: #f57c00; }
    .status-processing { background: #e3f2fd; color: #1976d2; }
    .status-submitted { background: #e8f5e9; color: #388e3c; }
    .status-approved { background: #c8e6c9; color: #2e7d32; }
    .status-rejected { background: #ffebee; color: #c62828; }
    .sticker-thumb { width: 60px; height: 60px; object-fit: contain; border-radius: 8px; background: #f5f5f5; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; }
    .modal.show { display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-gradient-to-r from-green-500 to-teal-400 text-white p-4">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">ğŸš€ ä¸Šæ¶ç”³è«‹ç®¡ç†</h1>
      <a href="/admin/" class="text-white hover:underline">â† è¿”å›ç®¡ç†é¦–é </a>
    </div>
  </nav>

  <div class="container mx-auto p-4">
    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
      <div class="bg-white rounded-lg shadow p-3 text-center">
        <div class="text-2xl font-bold text-orange-500" id="stat-pending">0</div>
        <div class="text-gray-500 text-xs">å¾…è™•ç†</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3 text-center">
        <div class="text-2xl font-bold text-blue-500" id="stat-processing">0</div>
        <div class="text-gray-500 text-xs">è™•ç†ä¸­</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3 text-center">
        <div class="text-2xl font-bold text-green-500" id="stat-submitted">0</div>
        <div class="text-gray-500 text-xs">å·²æäº¤LINE</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3 text-center">
        <div class="text-2xl font-bold text-emerald-600" id="stat-approved">0</div>
        <div class="text-gray-500 text-xs">å·²ä¸Šæ¶</div>
      </div>
      <div class="bg-white rounded-lg shadow p-3 text-center">
        <div class="text-2xl font-bold text-gray-500" id="stat-total">0</div>
        <div class="text-gray-500 text-xs">ç¸½ç”³è«‹</div>
      </div>
    </div>

    <!-- ç¯©é¸ -->
    <div class="bg-white rounded-lg shadow p-4 mb-4">
      <div class="flex flex-wrap gap-2">
        <button onclick="filterStatus('all')" class="filter-btn px-4 py-2 rounded-full text-sm bg-gray-200 hover:bg-gray-300" data-status="all">å…¨éƒ¨</button>
        <button onclick="filterStatus('pending')" class="filter-btn px-4 py-2 rounded-full text-sm status-pending" data-status="pending">â³ å¾…è™•ç†</button>
        <button onclick="filterStatus('processing')" class="filter-btn px-4 py-2 rounded-full text-sm status-processing" data-status="processing">ğŸ”„ è™•ç†ä¸­</button>
        <button onclick="filterStatus('submitted')" class="filter-btn px-4 py-2 rounded-full text-sm status-submitted" data-status="submitted">ğŸ“¤ å·²æäº¤</button>
        <button onclick="filterStatus('approved')" class="filter-btn px-4 py-2 rounded-full text-sm status-approved" data-status="approved">âœ… å·²ä¸Šæ¶</button>
      </div>
    </div>

    <!-- ç”³è«‹åˆ—è¡¨ -->
    <div id="list" class="space-y-4">
      <div class="text-center py-10 text-gray-500">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <!-- è©³æƒ…å½ˆçª— -->
  <div class="modal" id="detailModal">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="p-6" id="detailContent"></div>
    </div>
  </div>

  <script>
    const API_BASE = '/.netlify/functions';
    let applications = [];
    let currentFilter = 'all';

    function checkAuth() {
      const auth = JSON.parse(localStorage.getItem('adminAuth') || '{}');
      if (!auth.loggedIn || auth.expiry < Date.now()) {
        window.location.href = '/admin/login.html';
        return false;
      }
      return true;
    }

    async function loadApplications() {
      try {
        const res = await fetch(`${API_BASE}/admin-listing?action=list`);
        const data = await res.json();
        if (data.success) {
          applications = data.applications || [];
          updateStats();
          renderList();
        }
      } catch (e) {
        document.getElementById('list').innerHTML = '<div class="text-center py-10 text-red-500">è¼‰å…¥å¤±æ•—</div>';
      }
    }

    function updateStats() {
      const counts = { pending: 0, processing: 0, submitted: 0, approved: 0, rejected: 0 };
      applications.forEach(a => { if (counts[a.status] !== undefined) counts[a.status]++; });
      document.getElementById('stat-pending').textContent = counts.pending;
      document.getElementById('stat-processing').textContent = counts.processing;
      document.getElementById('stat-submitted').textContent = counts.submitted;
      document.getElementById('stat-approved').textContent = counts.approved;
      document.getElementById('stat-total').textContent = applications.length;
    }

    function filterStatus(status) {
      currentFilter = status;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('ring-2', btn.dataset.status === status);
        btn.classList.toggle('ring-offset-2', btn.dataset.status === status);
      });
      renderList();
    }

    function renderList() {
      const filtered = currentFilter === 'all' ? applications : applications.filter(a => a.status === currentFilter);
      if (filtered.length === 0) {
        document.getElementById('list').innerHTML = '<div class="text-center py-10 text-gray-500">æ²’æœ‰ç¬¦åˆçš„ç”³è«‹</div>';
        return;
      }
      document.getElementById('list').innerHTML = filtered.map(a => `
        <div class="bg-white rounded-lg shadow p-4 hover:shadow-lg transition cursor-pointer" onclick="showDetail('${a.application_id}')">
          <div class="flex items-center gap-4">
            <img src="${a.cover_url}" class="sticker-thumb" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2280%22>ğŸ–¼ï¸</text></svg>'">
            <div class="flex-1 min-w-0">
              <div class="font-bold text-gray-800 truncate">${a.name_en}</div>
              <div class="text-sm text-gray-500">${a.name_zh || ''} | NT$${a.price}</div>
              <div class="text-xs text-gray-400">${a.application_id} | ${new Date(a.created_at).toLocaleDateString()}</div>
            </div>
            <span class="status-${a.status} px-3 py-1 rounded-full text-xs font-medium">${getStatusText(a.status)}</span>
          </div>
        </div>
      `).join('');
    }

    function getStatusText(s) {
      return { pending: 'â³ å¾…è™•ç†', processing: 'ğŸ”„ è™•ç†ä¸­', submitted: 'ğŸ“¤ å·²æäº¤', approved: 'âœ… å·²ä¸Šæ¶', rejected: 'âŒ å·²æ‹’çµ•' }[s] || s;
    }

    async function showDetail(appId) {
      const a = applications.find(x => x.application_id === appId);
      if (!a) return;
      const stickers = JSON.parse(a.sticker_urls || '[]');
      document.getElementById('detailContent').innerHTML = `
        <div class="flex justify-between items-start mb-4">
          <h2 class="text-xl font-bold">ğŸ“‹ ç”³è«‹è©³æƒ…</h2>
          <button onclick="hideDetail()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mb-4">
          <div><span class="text-gray-500">ç”³è«‹ç·¨è™Ÿï¼š</span><strong>${a.application_id}</strong></div>
          <div><span class="text-gray-500">ç‹€æ…‹ï¼š</span><span class="status-${a.status} px-2 py-1 rounded text-sm">${getStatusText(a.status)}</span></div>
          <div><span class="text-gray-500">è‹±æ–‡åç¨±ï¼š</span><strong>${a.name_en}</strong></div>
          <div><span class="text-gray-500">ä¸­æ–‡åç¨±ï¼š</span>${a.name_zh || '-'}</div>
          <div><span class="text-gray-500">å”®åƒ¹ï¼š</span><strong>NT$${a.price}</strong></div>
          <div><span class="text-gray-500">ç”³è«‹æ™‚é–“ï¼š</span>${new Date(a.created_at).toLocaleString()}</div>
        </div>
        <div class="mb-4"><span class="text-gray-500">ç”¨æˆ¶ IDï¼š</span><code class="bg-gray-100 px-2 py-1 rounded text-xs">${a.user_id}</code></div>
        <div class="mb-4">
          <div class="text-gray-500 mb-2">å°é¢åœ–ç‰‡ï¼š</div>
          <img src="${a.cover_url}" class="w-32 h-32 object-contain bg-gray-100 rounded-lg">
        </div>
        <div class="mb-4">
          <div class="text-gray-500 mb-2">å…¨éƒ¨è²¼åœ– (${stickers.length}å¼µ)ï¼š</div>
          <div class="grid grid-cols-5 md:grid-cols-8 gap-2 max-h-60 overflow-y-auto p-2 bg-gray-50 rounded-lg">
            ${stickers.map(s => `<img src="${s.url}" class="w-full aspect-square object-contain bg-white rounded" title="${s.expression}">`).join('')}
          </div>
        </div>
        <div class="border-t pt-4 mb-4">
          <div class="text-gray-500 mb-2">ä¸‹è¼‰è²¼åœ–åŒ…ï¼š</div>
          <button onclick="downloadStickerPack('${a.application_id}', event)" class="px-4 py-2 rounded bg-blue-500 text-white hover:bg-blue-600 flex items-center gap-2">
            ğŸ“¥ ä¸‹è¼‰è²¼åœ–å£“ç¸®åŒ…
          </button>
        </div>
        <div class="border-t pt-4">
          <div class="text-gray-500 mb-2">æ›´æ–°ç‹€æ…‹ï¼š</div>
          <div class="flex flex-wrap gap-2">
            <button onclick="updateStatus('${a.application_id}','processing')" class="px-4 py-2 rounded status-processing">ğŸ”„ è™•ç†ä¸­</button>
            <button onclick="updateStatus('${a.application_id}','submitted')" class="px-4 py-2 rounded status-submitted">ğŸ“¤ å·²æäº¤LINE</button>
            <button onclick="updateStatus('${a.application_id}','approved')" class="px-4 py-2 rounded status-approved">âœ… å·²ä¸Šæ¶</button>
            <button onclick="updateStatus('${a.application_id}','rejected')" class="px-4 py-2 rounded status-rejected">âŒ æ‹’çµ•</button>
          </div>
        </div>
      `;
      document.getElementById('detailModal').classList.add('show');
    }

    function hideDetail() { document.getElementById('detailModal').classList.remove('show'); }

    async function downloadStickerPack(appId, event) {
      let btn = null;
      let originalText = 'ğŸ“¥ ä¸‹è¼‰è²¼åœ–å£“ç¸®åŒ…';

      try {
        btn = event?.target;
        originalText = btn?.textContent || originalText;
        if (btn) {
          btn.textContent = 'â³ æº–å‚™ä¸­...';
          btn.disabled = true;
        }

        console.log(`é–‹å§‹ä¸‹è¼‰ç”³è«‹ ${appId} çš„è²¼åœ–åŒ…...`);

        // ç¬¬ä¸€æ­¥ï¼šå•Ÿå‹•ç”Ÿæˆä»»å‹™
        const res = await fetch(`${API_BASE}/admin-listing`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'downloadPack', applicationId: appId })
        });

        console.log(`å›æ‡‰ç‹€æ…‹: ${res.status} ${res.statusText}`);
        console.log(`Content-Type: ${res.headers.get('Content-Type')}`);

        if (!res.ok) {
          const contentType = res.headers.get('Content-Type');
          let errorMsg = 'ä¸‹è¼‰å¤±æ•—';

          if (contentType && contentType.includes('application/json')) {
            const error = await res.json();
            errorMsg = error.error || error.message || errorMsg;
          } else {
            const text = await res.text();
            errorMsg = text || errorMsg;
          }

          throw new Error(errorMsg);
        }

        const responseData = await res.json();
        console.log('âœ… API å›æ‡‰:', responseData);

        if (!responseData.success) {
          throw new Error(responseData.error || 'æœªçŸ¥éŒ¯èª¤');
        }

        // å¦‚æœå·²ç¶“æº–å‚™å¥½ï¼Œç›´æ¥ä¸‹è¼‰
        if (responseData.ready && responseData.downloadUrl) {
          console.log(`ğŸ“¥ ä¸‹è¼‰é€£çµ: ${responseData.downloadUrl}`);
          window.open(responseData.downloadUrl, '_blank');
          alert('âœ… è²¼åœ–åŒ…å·²é–‹å§‹ä¸‹è¼‰');
          if (btn) {
            btn.textContent = originalText;
            btn.disabled = false;
          }
          return;
        }

        // æ­£åœ¨ç”Ÿæˆä¸­ï¼Œé–‹å§‹è¼ªè©¢
        if (btn) {
          btn.textContent = 'ğŸ”„ ç”Ÿæˆä¸­...';
        }

        const startTime = Date.now();
        const maxWaitTime = 5 * 60 * 1000; // æœ€å¤šç­‰ 5 åˆ†é˜

        while (Date.now() - startTime < maxWaitTime) {
          // ç­‰å¾… 2 ç§’å¾Œå†æª¢æŸ¥
          await new Promise(resolve => setTimeout(resolve, 2000));

          const checkRes = await fetch(`${API_BASE}/admin-listing?action=checkZip&applicationId=${appId}`);
          const checkData = await checkRes.json();

          if (checkData.success && checkData.ready && checkData.downloadUrl) {
            console.log(`âœ… ZIP å·²ç”Ÿæˆ: ${checkData.downloadUrl}`);
            window.open(checkData.downloadUrl, '_blank');
            alert('âœ… è²¼åœ–åŒ…å·²é–‹å§‹ä¸‹è¼‰');
            if (btn) {
              btn.textContent = originalText;
              btn.disabled = false;
            }
            return;
          }

          console.log('â³ æ­£åœ¨ç”Ÿæˆä¸­ï¼Œç¹¼çºŒç­‰å¾…...');
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          if (btn) {
            btn.textContent = `ğŸ”„ ç”Ÿæˆä¸­ (${elapsed}s)...`;
          }
        }

        throw new Error('ç”Ÿæˆè¶…æ™‚ï¼Œè«‹ç¨å¾Œé‡è©¦');

      } catch (e) {
        console.error('ä¸‹è¼‰éŒ¯èª¤:', e);
        alert('âŒ ä¸‹è¼‰å¤±æ•—ï¼š' + e.message);
        if (btn) {
          btn.textContent = originalText;
          btn.disabled = false;
        }
      }
    }

    async function updateStatus(appId, status) {
      if (!confirm(`ç¢ºå®šè¦å°‡ç‹€æ…‹æ›´æ–°ç‚ºã€Œ${getStatusText(status)}ã€ï¼Ÿ`)) return;
      try {
        const res = await fetch(`${API_BASE}/admin-listing`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'updateStatus', applicationId: appId, status })
        });
        const data = await res.json();
        if (data.success) {
          alert('âœ… ç‹€æ…‹å·²æ›´æ–°');
          hideDetail();
          loadApplications();
        } else { alert('âŒ ' + (data.error || 'æ›´æ–°å¤±æ•—')); }
      } catch (e) { alert('âŒ æ“ä½œå¤±æ•—'); }
    }

    if (checkAuth()) loadApplications();
  </script>
</body>
</html>

