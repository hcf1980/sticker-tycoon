<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å„ªæƒ åˆ¸ç®¡ç† - è²¼åœ–å¤§äº¨</title>

  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="icon" type="image/png" sizes="192x192" href="/logo-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="/tech-theme.css" rel="stylesheet" />

  <script type="application/json" id="supabase-config">
  {
    "url": "https://dpuxmetnpghlfgrmthnv.supabase.co",
    "anonKey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRwdXhtZXRucGdobGZncm10aG52Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNDMwNzcsImV4cCI6MjA3OTgxOTA3N30._fleTY6Pw4myjEIjtAxkYYm6L8MfPeKq915zn68pM_8"
  }
  </script>
</head>

<body class="tech-bg min-h-screen">
  <style>
    /* ä¿®æ­£ tech-theme å…¨å±€æ–‡å­—è‰²å°è‡´ input/textarea è¼¸å…¥æ–‡å­—çœ‹ä¸è¦‹ï¼ˆé»‘å­— + ç™½åº•ï¼‰ */
    #adminApiKeyInput,
    #campaignModal input,
    #campaignModal textarea,
    #campaignModal select {
      color: #000 !important;
      -webkit-text-fill-color: #000 !important;
      caret-color: #000 !important;
    }

    #campaignModal input::placeholder,
    #campaignModal textarea::placeholder,
    #adminApiKeyInput::placeholder {
      color: #6b7280 !important;
      -webkit-text-fill-color: #6b7280 !important;
    }

    #campaignModal input:focus,
    #campaignModal textarea:focus,
    #adminApiKeyInput:focus {
      outline: none;
    }
  </style>
  <nav class="admin-nav">
    <div class="container mx-auto px-4 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="relative">
            <img src="/logo-192.png" alt="è²¼åœ–å¤§äº¨ Logo" class="w-10 h-10 rounded-lg" />
            <div class="absolute -inset-1 bg-gradient-to-r from-cyan-500 to-purple-500 rounded-lg blur opacity-30"></div>
          </div>
          <div>
            <h1 class="text-xl font-bold text-white">è²¼åœ–å¤§äº¨</h1>
            <p class="text-xs text-cyan-400">å„ªæƒ åˆ¸ç®¡ç†</p>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <a href="/admin/" class="text-gray-400 hover:text-cyan-400 transition text-sm">â† è¿”å›ç®¡ç†é¦–é </a>
          <button id="logoutBtn" class="text-gray-400 hover:text-red-400 transition text-sm">ç™»å‡º</button>
        </div>
      </div>
    </div>
  </nav>

  <div class="container mx-auto p-6">
    <div class="mb-6 flex flex-col md:flex-row md:items-end md:justify-between gap-4">
      <div>
        <h2 class="text-2xl font-bold text-white">ğŸ« å„ªæƒ åˆ¸æ´»å‹•</h2>
        <p class="text-gray-400 text-sm">å»ºç«‹æ´»å‹•ã€ç”Ÿæˆåˆ¸åœ–ã€æŸ¥çœ‹å…Œæ›æ˜ç´°</p>
      </div>

      <div class="flex flex-col sm:flex-row gap-2">
        <input id="adminApiKeyInput" type="password" placeholder="ADMIN_API_KEYï¼ˆå¿…å¡«ï¼‰" class="w-full sm:w-72 px-4 py-2 rounded-lg bg-white text-black border border-gray-300 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
        <button id="saveAdminKeyBtn" class="btn-neon-solid px-4 py-2">ä¿å­˜</button>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="stat-card">
        <div class="value" id="stat-total">-</div>
        <div class="text-gray-400 text-sm mt-1">æ´»å‹•ç¸½æ•¸</div>
      </div>
      <div class="stat-card">
        <div class="value" id="stat-active">-</div>
        <div class="text-gray-400 text-sm mt-1">å•Ÿç”¨ä¸­</div>
      </div>
      <div class="stat-card">
        <div class="value" id="stat-redeemed">-</div>
        <div class="text-gray-400 text-sm mt-1">ç¸½å…Œæ›ï¼ˆè¿‘ 500 ç­†ç´¯åŠ ï¼‰</div>
      </div>
      <div class="stat-card">
        <div class="value" id="stat-updated">-</div>
        <div class="text-gray-400 text-sm mt-1">æœ€å¾Œæ›´æ–°</div>
      </div>
    </div>

    <div class="glass-card p-4 mb-6">
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
        <div class="flex flex-col sm:flex-row gap-2 w-full">
          <input id="searchInput" type="text" placeholder="æœå°‹æ´»å‹•åç¨±æˆ–å…Œæ›ç¢¼..." class="flex-1 px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
          <select id="statusFilter" class="px-4 py-2 rounded-lg bg-white/5 border border-white/10 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50">
            <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
            <option value="active">é€²è¡Œä¸­</option>
            <option value="upcoming">æœªé–‹å§‹</option>
            <option value="ended">å·²çµæŸ</option>
            <option value="disabled">å·²åœç”¨</option>
          </select>
        </div>

        <div class="flex gap-2">
          <button id="refreshBtn" class="btn-neon px-4 py-2">åˆ·æ–°</button>
          <button id="openCreateBtn" class="btn-neon-solid px-4 py-2">+ æ–°å¢æ´»å‹•</button>
        </div>
      </div>
    </div>

    <div id="campaignList" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
  </div>

  <div id="modalBackdrop" class="hidden fixed inset-0 bg-black/60 z-50"></div>

  <div id="campaignModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="min-h-full flex items-center justify-center p-4">
      <div class="glass-card w-full max-w-4xl p-4 md:p-6">
        <div class="flex items-start justify-between gap-4 mb-4">
          <div>
            <h3 class="text-white font-bold text-lg" id="campaignModalTitle">æ–°å¢å„ªæƒ åˆ¸æ´»å‹•</h3>
            <p class="text-gray-400 text-sm">å…Œæ›ç¢¼å°‡è‡ªå‹•ç”Ÿæˆï¼ˆ5~7 ç¢¼ï¼‰</p>
          </div>
          <button id="closeCampaignModal" class="text-gray-400 hover:text-white">âœ•</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="space-y-3">
            <input type="hidden" id="campaignIdInput" />

            <div>
              <label class="block text-sm text-gray-300 mb-1">æ´»å‹•åç¨±</label>
              <input id="nameInput" class="w-full px-4 py-2 rounded-lg bg-white text-black border border-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-500/50" placeholder="ä¾‹ï¼šæ–°å¹´åŠ ç¢¼æ´»å‹•" />
            </div>

            <div>
              <label class="block text-sm text-gray-300 mb-1">å“ç‰Œæ¨™èªï¼ˆé¸å¡«ï¼‰</label>
              <input id="sloganInput" class="w-full px-4 py-2 rounded-lg bg-white text-black border border-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-500/50" placeholder="è²¼åœ–å¤§äº¨ Sticker Tycoon" />
            </div>

            <div>
              <label class="block text-sm text-gray-300 mb-1">åŠ ä»£å¹£æ•¸</label>
              <input id="tokenAmountInput" type="number" min="1" value="20" class="w-full px-4 py-2 rounded-lg bg-white text-black border border-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
              <p class="text-xs text-gray-500 mt-1">ä¾ä½ çš„éœ€æ±‚ï¼šæœ‰æ•ˆæœŸå›ºå®š 30 å¤©ï¼ˆæ²¿ç”¨æ—¢æœ‰ token_ledger è¦å‰‡ï¼‰</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-sm text-gray-300 mb-1">ä½¿ç”¨é–‹å§‹</label>
                <input id="startDateInput" type="date" class="w-full px-4 py-2 rounded-lg bg-white text-black border border-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
              </div>
              <div>
                <label class="block text-sm text-gray-300 mb-1">ä½¿ç”¨çµæŸ</label>
                <input id="endDateInput" type="date" class="w-full px-4 py-2 rounded-lg bg-white text-black border border-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-500/50" />
              </div>
            </div>

            <div class="flex items-center gap-2">
              <input id="isActiveInput" type="checkbox" class="h-4 w-4" checked />
              <label for="isActiveInput" class="text-sm text-gray-300">å»ºç«‹å¾Œç«‹å³å•Ÿç”¨</label>
            </div>

            <div class="flex gap-2 pt-2">
              <button id="cancelCampaignBtn" class="btn-neon px-4 py-2 flex-1">å–æ¶ˆ</button>
              <button id="deleteCampaignBtn" class="btn-neon px-4 py-2 flex-1 hidden" style="background: linear-gradient(135deg, #ef4444, #b91c1c);">åˆªé™¤æ´»å‹•</button>
              <button id="createCampaignBtn" class="btn-neon-solid px-4 py-2 flex-1">å»ºç«‹æ´»å‹•ï¼ˆå«ç”Ÿæˆåˆ¸åœ–ï¼‰</button>
            </div>
          </div>

          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <h4 class="text-white font-bold">åˆ¸åœ–é è¦½ï¼ˆ4:3 æµ·å ±ï¼‰</h4>
                <p class="text-gray-400 text-xs">è‹¥ä¸é©åˆï¼Œå¯è¿½åŠ æ¢ä»¶å¾Œé‡æ–°ç”Ÿæˆ</p>
              </div>
              <a id="downloadImageLink" href="#" class="text-cyan-400 hover:text-cyan-300 text-sm hidden" target="_blank" rel="noopener">ä¸‹è¼‰</a>
            </div>

            <div class="bg-white/5 border border-white/10 rounded-lg overflow-hidden">
              <div class="aspect-w-4 aspect-h-3">
                <img id="couponPreviewImg" class="w-full h-full object-cover hidden" alt="coupon" />
                <div id="couponPreviewPlaceholder" class="w-full h-56 md:h-72 flex items-center justify-center text-gray-500">å°šæœªç”Ÿæˆ</div>
              </div>
            </div>

            <div class="glass-card p-3">
              <div class="flex items-center justify-between gap-2">
                <div>
                  <div class="text-gray-400 text-xs">å…Œæ›ç¢¼</div>
                  <div class="text-white font-mono" id="redeemCodeText">-</div>
                </div>
                <button id="copyCodeBtn" class="btn-neon px-4 py-2" disabled>è¤‡è£½</button>
              </div>

              <div class="mt-3">
                <label class="block text-sm text-gray-300 mb-1">é‡æ–°ç”Ÿæˆæ¢ä»¶ï¼ˆé¸å¡«ï¼‰</label>
                <textarea id="extraPromptInput" rows="3" class="w-full px-4 py-2 rounded-lg bg-white text-black border border-gray-300 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/50" placeholder="ä¾‹ï¼šå…Œæ›ç¢¼æ›´å¤§ã€æ›´é†’ç›®ã€èƒŒæ™¯æ›´ç´«ã€æ›´ç§‘æŠ€æ„Ÿ"></textarea>
                <div class="flex gap-2 mt-2">
                  <button id="regenerateBtn" class="btn-neon px-4 py-2 flex-1" disabled>é‡æ–°ç”Ÿæˆåˆ¸åœ–</button>
                </div>
              </div>
            </div>

            <div class="glass-card p-3">
              <div class="flex items-center justify-between">
                <h4 class="text-white font-bold">ä½¿ç”¨è€…æ˜ç´°ï¼ˆæœ€è¿‘ 500 ç­†ï¼‰</h4>
                <button id="openStatsBtn" class="btn-neon px-4 py-2" disabled>æŸ¥çœ‹</button>
              </div>
              <p class="text-gray-400 text-xs mt-1">å¯æŒæ¡å“ªäº›ç”¨æˆ¶ç”¨éã€ä½•æ™‚ä½¿ç”¨ã€ç‹€æ…‹</p>
            </div>
          </div>
        </div>

        <div class="mt-4 text-right">
          <p class="text-xs text-gray-500" id="modalHint">æç¤ºï¼šè«‹å…ˆè¼¸å…¥ä¸¦ä¿å­˜ ADMIN_API_KEY æ‰èƒ½æ“ä½œ</p>
        </div>
      </div>
    </div>
  </div>

  <div id="statsModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="min-h-full flex items-center justify-center p-4">
      <div class="glass-card w-full max-w-5xl p-4 md:p-6">
        <div class="flex items-start justify-between gap-4 mb-4">
          <div>
            <h3 class="text-white font-bold text-lg" id="statsTitle">æ´»å‹•çµ±è¨ˆ</h3>
            <p class="text-gray-400 text-sm" id="statsSubtitle">-</p>
          </div>
          <button id="closeStatsModal" class="text-gray-400 hover:text-white">âœ•</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
          <div class="stat-card">
            <div class="value" id="statsTotal">-</div>
            <div class="text-gray-400 text-sm mt-1">ç¸½ç­†æ•¸</div>
          </div>
          <div class="stat-card">
            <div class="value" id="statsSuccess">-</div>
            <div class="text-gray-400 text-sm mt-1">æˆåŠŸ</div>
          </div>
          <div class="stat-card">
            <div class="value" id="statsOther">-</div>
            <div class="text-gray-400 text-sm mt-1">å…¶ä»–ç‹€æ…‹</div>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-white/5">
              <tr>
                <th class="px-3 py-2 text-left text-xs text-gray-300">ç”¨æˆ¶</th>
                <th class="px-3 py-2 text-left text-xs text-gray-300">User ID</th>
                <th class="px-3 py-2 text-left text-xs text-gray-300">ç‹€æ…‹</th>
                <th class="px-3 py-2 text-right text-xs text-gray-300">ä»£å¹£</th>
                <th class="px-3 py-2 text-right text-xs text-gray-300">æ™‚é–“</th>
              </tr>
            </thead>
            <tbody id="statsTableBody" class="divide-y divide-white/10"></tbody>
          </table>
        </div>

        <div class="flex justify-end gap-2 mt-4">
          <button id="exportCsvBtn" class="btn-neon px-4 py-2">åŒ¯å‡º CSV</button>
          <button id="closeStatsBtn" class="btn-neon-solid px-4 py-2">é—œé–‰</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.js"></script>
  <script src="/admin/supabase-admin-client.js"></script>
  <script>
    if (!checkAdminAuth()) {
      document.body.innerHTML = `
        <div class="tech-bg min-h-screen flex items-center justify-center">
          <div class="text-center">
            <div class="loader-tech mx-auto mb-4"></div>
            <p class="text-gray-400">æ­£åœ¨è·³è½‰åˆ°ç™»å…¥é é¢...</p>
          </div>
        </div>
      `;
    }

    const state = {
      campaigns: [],
      selectedCampaign: null,
      adminApiKey: null,
      lastStats: null
    };

    const el = (id) => document.getElementById(id);

    function nowDateForInput() {
      const d = new Date();
      // date input expects local date; we assume admin operates in Taiwan time (local)
      return d.toISOString().slice(0, 10);
    }

    function addDaysDateForInput(days) {
      const d = new Date();
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0, 10);
    }

    function taipeiDateRangeToIso(dateStart, dateEnd) {
      // dateStart/dateEnd are YYYY-MM-DD
      // Start: 00:00:00+08:00, End: 23:59:59+08:00
      const startIso = new Date(`${dateStart}T00:00:00+08:00`).toISOString();
      const endIso = new Date(`${dateEnd}T23:59:59+08:00`).toISOString();
      return { startIso, endIso };
    }

    function isoToTaipeiDateInput(iso) {
      if (!iso) return '';
      // Convert ISO -> Taipei date (YYYY-MM-DD)
      const d = new Date(iso);
      const utc = d.getTime() + d.getTimezoneOffset() * 60000;
      const taipei = new Date(utc + 8 * 60 * 60 * 1000);
      return taipei.toISOString().slice(0, 10);
    }

    function formatDateTime(iso) {
      if (!iso) return '-';
      try {
        return new Date(iso).toLocaleString('zh-TW');
      } catch {
        return String(iso);
      }
    }

    function escapeHtml(str) {
      return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function getAdminApiKey() {
      return localStorage.getItem('adminApiKey') || '';
    }

    function setAdminApiKey(v) {
      localStorage.setItem('adminApiKey', v);
      state.adminApiKey = v;
    }

    function adminHeaders() {
      const key = state.adminApiKey;
      return {
        'Content-Type': 'application/json',
        'X-Admin-Api-Key': key
      };
    }

    function toast(message) {
      alert(message);
    }

    function openModal(modalId) {
      el('modalBackdrop').classList.remove('hidden');
      el(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
      el(modalId).classList.add('hidden');
      el('modalBackdrop').classList.add('hidden');
    }

    function statusOfCampaign(c) {
      const now = new Date();
      const claimStart = new Date(c.claim_start_at);
      const claimEnd = new Date(c.claim_end_at);

      if (!c.is_active) return 'disabled';
      if (now < claimStart) return 'upcoming';
      if (now > claimEnd) return 'ended';
      return 'active';
    }

    function statusBadge(status) {
      const map = {
        active: 'tag-green',
        upcoming: 'tag-purple',
        ended: 'tag-yellow',
        disabled: 'tag-red'
      };
      const label = {
        active: 'é€²è¡Œä¸­',
        upcoming: 'æœªé–‹å§‹',
        ended: 'å·²çµæŸ',
        disabled: 'å·²åœç”¨'
      };

      const klass = map[status] || 'tag-tech';
      return `<span class="${klass} text-xs px-2 py-1 rounded-full">${label[status] || status}</span>`;
    }

    function renderCampaignList() {
      const listEl = el('campaignList');
      const search = el('searchInput').value.trim().toLowerCase();
      const filter = el('statusFilter').value;

      const items = state.campaigns.filter((c) => {
        const s = statusOfCampaign(c);
        const okFilter = filter === 'all' ? true : s === filter;
        const okSearch = !search
          ? true
          : String(c.name || '').toLowerCase().includes(search) || String(c.redeem_code || '').toLowerCase().includes(search);
        return okFilter && okSearch;
      });

      if (items.length === 0) {
        listEl.innerHTML = `
          <div class="glass-card p-6 text-center text-gray-400 col-span-full">
            æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ´»å‹•
          </div>
        `;
        return;
      }

      listEl.innerHTML = items
        .map((c) => {
          const s = statusOfCampaign(c);
          const img = c.image_url
            ? `<img src="${c.image_url}" class="w-full h-40 object-cover rounded-lg border border-white/10" />`
            : `<div class="w-full h-40 rounded-lg bg-white/5 border border-white/10 flex items-center justify-center text-gray-500">å°šæœªç”Ÿæˆåˆ¸åœ–</div>`;

          return `
            <div class="glass-card p-4">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <div class="flex items-center gap-2">
                    <h3 class="text-white font-bold">${escapeHtml(c.name)}</h3>
                    ${statusBadge(s)}
                  </div>
                  <div class="text-gray-400 text-xs mt-1">å…Œæ›ç¢¼ï¼š<span class="font-mono text-white">${escapeHtml(c.redeem_code)}</span></div>
                  <div class="text-gray-500 text-xs mt-1">+${c.token_amount} ä»£å¹£</div>
                </div>
                <div class="flex gap-2">
                  <button class="btn-neon px-3 py-2 text-sm" data-action="toggle" data-id="${c.id}" data-active="${c.is_active ? '1' : '0'}">${c.is_active ? 'åœç”¨' : 'å•Ÿç”¨'}</button>
                  <button class="btn-neon-solid px-3 py-2 text-sm" data-action="manage" data-id="${c.id}">ç®¡ç†</button>
                </div>
              </div>

              <div class="mt-3">
                ${img}
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-3 text-xs text-gray-400">
                <div>é ˜ç”¨ï¼š${formatDateTime(c.claim_start_at)} ~ ${formatDateTime(c.claim_end_at)}</div>
                <div>å•Ÿç”¨ï¼š${formatDateTime(c.activate_start_at)} ~ ${formatDateTime(c.activate_end_at)}</div>
              </div>
            </div>
          `;
        })
        .join('');

      // bind actions
      listEl.querySelectorAll('button[data-action="manage"]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          const c = state.campaigns.find((x) => x.id === id);
          if (!c) return;
          openCampaignModal(c);
        });
      });

      listEl.querySelectorAll('button[data-action="toggle"]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const isActive = btn.getAttribute('data-active') === '1';
          await setActive(id, !isActive);
        });
      });
    }

    function updateTopStats() {
      const total = state.campaigns.length;
      const active = state.campaigns.filter((c) => statusOfCampaign(c) === 'active').length;
      el('stat-total').textContent = String(total);
      el('stat-active').textContent = String(active);

      const redeemed = state.campaigns.reduce((sum, c) => sum + (c.__redeemCount || 0), 0);
      el('stat-redeemed').textContent = redeemed ? String(redeemed) : '-';

      el('stat-updated').textContent = new Date().toLocaleTimeString('zh-TW');
    }

    async function fetchCampaignStatsQuick(campaignId) {
      // åªæ‹¿ totalï¼ˆç”¨æ–¼é ‚éƒ¨ summaryï¼›é¿å…æ¯æ¬¡ list æ‹‰å…¨é‡æ˜ç´°ï¼‰
      const res = await fetch(`/.netlify/functions/admin-coupons?action=campaign-stats&campaignId=${encodeURIComponent(campaignId)}`, {
        method: 'GET',
        headers: adminHeaders()
      });
      const data = await res.json();
      if (!data.success) throw new Error(data.error || 'stats failed');
      return data;
    }

    async function loadCampaigns() {
      const key = state.adminApiKey;
      if (!key) {
        el('campaignList').innerHTML = `<div class="glass-card p-6 text-center text-gray-400 col-span-full">è«‹å…ˆè¼¸å…¥ä¸¦ä¿å­˜ ADMIN_API_KEY</div>`;
        el('stat-total').textContent = '-';
        el('stat-active').textContent = '-';
        el('stat-redeemed').textContent = '-';
        el('stat-updated').textContent = '-';
        return;
      }

      el('campaignList').innerHTML = `<div class="glass-card p-6 text-center text-gray-400 col-span-full">è¼‰å…¥ä¸­...</div>`;

      const res = await fetch('/.netlify/functions/admin-coupons?action=list-campaigns', {
        method: 'GET',
        headers: adminHeaders()
      });
      const data = await res.json();
      if (!data.success) {
        toast(`è¼‰å…¥å¤±æ•—ï¼š${data.error || 'unknown'}`);
        return;
      }

      state.campaigns = data.campaigns || [];

      // å¿«é€Ÿçµ±è¨ˆï¼šåªå°å‰ 10 å€‹æ‹‰ statsï¼ˆé¿å…å¤ªæ…¢ï¼‰ï¼Œå…¶é¤˜ç•™ç©º
      const sample = state.campaigns.slice(0, 10);
      await Promise.all(
        sample.map(async (c) => {
          try {
            const s = await fetchCampaignStatsQuick(c.id);
            c.__redeemCount = s.stats?.total || 0;
          } catch {
            c.__redeemCount = 0;
          }
        })
      );

      updateTopStats();
      renderCampaignList();
    }

    function resetCampaignModalUI() {
      el('campaignIdInput').value = '';
      el('nameInput').value = '';
      el('sloganInput').value = '';
      el('tokenAmountInput').value = 20;
      el('startDateInput').value = nowDateForInput();
      el('endDateInput').value = addDaysDateForInput(7);
      el('isActiveInput').checked = true;

      el('deleteCampaignBtn').classList.add('hidden');

      el('redeemCodeText').textContent = '-';
      el('copyCodeBtn').disabled = true;
      el('regenerateBtn').disabled = true;
      el('openStatsBtn').disabled = true;
      el('extraPromptInput').value = '';

      el('couponPreviewImg').classList.add('hidden');
      el('couponPreviewPlaceholder').classList.remove('hidden');
      el('downloadImageLink').classList.add('hidden');
      el('downloadImageLink').href = '#';
    }

    function openCampaignModal(campaign) {
      resetCampaignModalUI();

      if (campaign) {
        state.selectedCampaign = campaign;
        el('campaignModalTitle').textContent = 'ç·¨è¼¯å„ªæƒ åˆ¸æ´»å‹•';
        el('createCampaignBtn').textContent = 'æ›´æ–°æ´»å‹•';
        el('createCampaignBtn').disabled = false;
        el('deleteCampaignBtn').classList.remove('hidden');

        el('campaignIdInput').value = campaign.id;
        el('nameInput').value = campaign.name || '';
        el('sloganInput').value = campaign.slogan || '';
        el('tokenAmountInput').value = campaign.token_amount || 20;
        el('startDateInput').value = isoToTaipeiDateInput(campaign.claim_start_at);
        el('endDateInput').value = isoToTaipeiDateInput(campaign.claim_end_at);
        el('isActiveInput').checked = !!campaign.is_active;

        el('redeemCodeText').textContent = campaign.redeem_code || '-';
        el('copyCodeBtn').disabled = !campaign.redeem_code;
        el('regenerateBtn').disabled = false;
        el('openStatsBtn').disabled = false;

        if (campaign.image_url) {
          el('couponPreviewImg').src = campaign.image_url;
          el('couponPreviewImg').classList.remove('hidden');
          el('couponPreviewPlaceholder').classList.add('hidden');
          el('downloadImageLink').classList.remove('hidden');
          el('downloadImageLink').href = campaign.image_url;
        }

        el('modalHint').textContent = 'å¯é‡æ–°ç”Ÿæˆåˆ¸åœ–ï¼Œä¸¦æŸ¥çœ‹ä½¿ç”¨è€…æ˜ç´°';
      } else {
        state.selectedCampaign = null;
        el('campaignModalTitle').textContent = 'æ–°å¢å„ªæƒ åˆ¸æ´»å‹•';
        el('createCampaignBtn').textContent = 'å»ºç«‹æ´»å‹•ï¼ˆå«ç”Ÿæˆåˆ¸åœ–ï¼‰';
        el('createCampaignBtn').disabled = false;
        el('modalHint').textContent = 'å»ºç«‹å¾Œæœƒè‡ªå‹•ç”Ÿæˆå…Œæ›ç¢¼èˆ‡åˆ¸åœ–';
      }

      openModal('campaignModal');
    }

    function toInputLocal(iso) {
      // deprecated: kept to avoid runtime errors in old references
      return isoToTaipeiDateInput(iso);
    }

    async function createCampaign() {
      if (!state.adminApiKey) {
        toast('è«‹å…ˆä¿å­˜ ADMIN_API_KEY');
        return;
      }

      const payload = {
        name: el('nameInput').value.trim(),
        slogan: el('sloganInput').value.trim() || null,
        tokenAmount: Number(el('tokenAmountInput').value || 0),
        // UI åªæœ‰ã€Œä½¿ç”¨é–‹å§‹/ä½¿ç”¨çµæŸã€å…©å€‹æ—¥æœŸï¼ˆå°ç£æ™‚é–“ï¼‰
        // å¾Œç«¯ä»æ²¿ç”¨ claim/activate å››æ¬„ä½ï¼Œä½†é€™è£¡çµ±ä¸€ç”¨åŒä¸€å€‹å€é–“
        ...(() => {
          const startDate = el('startDateInput').value;
          const endDate = el('endDateInput').value;
          if (!startDate || !endDate) {
            throw new Error('è«‹é¸æ“‡ä½¿ç”¨é–‹å§‹èˆ‡ä½¿ç”¨çµæŸæ—¥æœŸ');
          }
          const { startIso, endIso } = taipeiDateRangeToIso(startDate, endDate);
          return {
            claimStartAt: startIso,
            claimEndAt: endIso,
            activateStartAt: startIso,
            activateEndAt: endIso
          };
        })()
      };

      if (!payload.name) {
        toast('è«‹è¼¸å…¥æ´»å‹•åç¨±');
        return;
      }
      if (!payload.tokenAmount || payload.tokenAmount <= 0) {
        toast('åŠ ä»£å¹£æ•¸å¿…é ˆå¤§æ–¼ 0');
        return;
      }

      el('createCampaignBtn').disabled = true;
      el('createCampaignBtn').textContent = 'å»ºç«‹ä¸­...';

      try {
        const res = await fetch('/.netlify/functions/admin-coupons?action=create-campaign', {
          method: 'POST',
          headers: adminHeaders(),
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'create failed');

        // è‹¥ä½¿ç”¨è€…å‹¾é¸æœªå•Ÿç”¨ï¼Œé¡å¤– set-active
        if (!el('isActiveInput').checked) {
          await setActive(data.campaign.id, false, { silent: true });
          data.campaign.is_active = false;
        }

        toast('âœ… å»ºç«‹æˆåŠŸ');
        // ç›´æ¥åˆ‡æ›åˆ°ç®¡ç†æ¨¡å¼
        const created = data.campaign;
        await loadCampaigns();
        const fresh = state.campaigns.find((x) => x.id === created.id) || created;
        openCampaignModal(fresh);
      } catch (e) {
        toast(`âŒ å»ºç«‹å¤±æ•—ï¼š${e.message}`);
      } finally {
        el('createCampaignBtn').disabled = false;
        el('createCampaignBtn').textContent = 'å»ºç«‹æ´»å‹•ï¼ˆå«ç”Ÿæˆåˆ¸åœ–ï¼‰';
      }
    }

    async function setActive(campaignId, isActive, opts = {}) {
      if (!state.adminApiKey) {
        toast('è«‹å…ˆä¿å­˜ ADMIN_API_KEY');
        return;
      }

      const confirmText = isActive ? 'ç¢ºå®šè¦å•Ÿç”¨æ­¤æ´»å‹•ï¼Ÿ' : 'ç¢ºå®šè¦åœç”¨æ­¤æ´»å‹•ï¼Ÿ';
      if (!opts.silent && !confirm(confirmText)) return;

      try {
        const res = await fetch('/.netlify/functions/admin-coupons?action=set-active', {
          method: 'POST',
          headers: adminHeaders(),
          body: JSON.stringify({ campaignId, isActive })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'set-active failed');
        if (!opts.silent) toast('âœ… å·²æ›´æ–°ç‹€æ…‹');
        await loadCampaigns();
      } catch (e) {
        toast(`âŒ æ›´æ–°ç‹€æ…‹å¤±æ•—ï¼š${e.message}`);
      }
    }

    async function deleteCurrentCampaign() {
      if (!state.selectedCampaign) {
        toast('è«‹å…ˆé¸æ“‡æ´»å‹•');
        return;
      }

      const { id, redeem_code, name } = state.selectedCampaign;
      const input = prompt(`ç‚ºå®‰å…¨èµ·è¦‹ï¼Œè«‹è¼¸å…¥æ´»å‹•å…Œæ›ç¢¼ã€Œ${redeem_code}ã€ä»¥ç¢ºèªåˆªé™¤æ´»å‹•ã€Œ${name}ã€`);

      if (!input) return;

      if (input.trim().toUpperCase() !== redeem_code.toUpperCase()) {
        toast('å…Œæ›ç¢¼è¼¸å…¥éŒ¯èª¤ï¼Œå·²å–æ¶ˆåˆªé™¤');
        return;
      }

      try {
        const res = await fetch('/.netlify/functions/admin-coupons?action=delete-campaign', {
          method: 'POST',
          headers: adminHeaders(),
          body: JSON.stringify({ campaignId: id })
        });

        const data = await res.json();
        if (!data.success) {
          if (data.code === 'HAS_REDEMPTIONS') {
            toast('âŒ æ­¤æ´»å‹•å·²æœ‰ä½¿ç”¨ç´€éŒ„ï¼Œç„¡æ³•åˆªé™¤ã€‚è«‹æ”¹ç”¨ã€Œåœç”¨ã€åŠŸèƒ½ã€‚');
          } else {
            throw new Error(data.error || 'delete failed');
          }
        } else {
          toast('âœ… æ´»å‹•å·²æˆåŠŸåˆªé™¤');
          closeModal('campaignModal');
          await loadCampaigns();
        }
      } catch (e) {
        toast(`âŒ åˆªé™¤å¤±æ•—ï¼š${e.message}`);
      }
    }

    async function regenerateImage() {
      if (!state.selectedCampaign) {
        toast('è«‹å…ˆé¸æ“‡æ´»å‹•');
        return;
      }

      const extraPrompt = el('extraPromptInput').value.trim() || null;
      el('regenerateBtn').disabled = true;
      el('regenerateBtn').textContent = 'ç”Ÿæˆä¸­...';

      try {
        const res = await fetch('/.netlify/functions/admin-coupons?action=regenerate-image', {
          method: 'POST',
          headers: adminHeaders(),
          body: JSON.stringify({ campaignId: state.selectedCampaign.id, extraPrompt })
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'regenerate failed');
        toast('âœ… å·²é‡æ–°ç”Ÿæˆåˆ¸åœ–');

        // æ›´æ–° modal é è¦½
        const updated = data.campaign;
        state.selectedCampaign = updated;
        el('couponPreviewImg').src = updated.image_url;
        el('couponPreviewImg').classList.remove('hidden');
        el('couponPreviewPlaceholder').classList.add('hidden');
        el('downloadImageLink').classList.remove('hidden');
        el('downloadImageLink').href = updated.image_url;

        // åŒæ­¥åˆ—è¡¨
        await loadCampaigns();
      } catch (e) {
        toast(`âŒ é‡æ–°ç”Ÿæˆå¤±æ•—ï¼š${e.message}`);
      } finally {
        el('regenerateBtn').disabled = false;
        el('regenerateBtn').textContent = 'é‡æ–°ç”Ÿæˆåˆ¸åœ–';
      }
    }

    async function openStats() {
      if (!state.selectedCampaign) return;
      const id = state.selectedCampaign.id;

      el('statsTableBody').innerHTML = `<tr><td colspan="5" class="px-3 py-6 text-center text-gray-400">è¼‰å…¥ä¸­...</td></tr>`;

      try {
        const res = await fetch(`/.netlify/functions/admin-coupons?action=campaign-stats&campaignId=${encodeURIComponent(id)}`, {
          method: 'GET',
          headers: adminHeaders()
        });
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'stats failed');

        state.lastStats = data;

        el('statsTitle').textContent = `æ´»å‹•çµ±è¨ˆï¼š${data.campaign.name}`;
        el('statsSubtitle').textContent = `å…Œæ›ç¢¼ ${data.campaign.redeem_code} / +${data.campaign.token_amount} ä»£å¹£`;

        const total = data.stats?.total || 0;
        const success = data.stats?.byStatus?.success || 0;
        const other = total - success;
        el('statsTotal').textContent = String(total);
        el('statsSuccess').textContent = String(success);
        el('statsOther').textContent = String(other);

        const rows = (data.redemptions || []).map((r) => {
          const userName = r.user?.display_name || 'æœªçŸ¥ç”¨æˆ¶';
          const userId = r.user_id;
          const status = r.status;
          const token = r.token_amount;
          const at = formatDateTime(r.created_at);

          return `
            <tr class="hover:bg-white/5">
              <td class="px-3 py-2 text-sm text-white">
                <div class="flex items-center gap-2">
                  ${r.user?.picture_url ? `<img src="${r.user.picture_url}" class="w-6 h-6 rounded-full" />` : `<div class="w-6 h-6 rounded-full bg-white/10"></div>`}
                  <span>${escapeHtml(userName)}</span>
                </div>
              </td>
              <td class="px-3 py-2 text-xs text-gray-300 font-mono">${escapeHtml(userId)}</td>
              <td class="px-3 py-2 text-sm ${status === 'success' ? 'text-green-400' : 'text-yellow-300'}">${escapeHtml(status)}</td>
              <td class="px-3 py-2 text-right text-sm text-white">+${token}</td>
              <td class="px-3 py-2 text-right text-xs text-gray-300">${escapeHtml(at)}</td>
            </tr>
          `;
        });

        el('statsTableBody').innerHTML = rows.length
          ? rows.join('')
          : `<tr><td colspan="5" class="px-3 py-6 text-center text-gray-400">å°šç„¡å…Œæ›ç´€éŒ„</td></tr>`;

        openModal('statsModal');
      } catch (e) {
        toast(`âŒ è¼‰å…¥çµ±è¨ˆå¤±æ•—ï¼š${e.message}`);
      }
    }

    function exportCsv() {
      const data = state.lastStats;
      if (!data) {
        toast('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
        return;
      }

      const rows = data.redemptions || [];
      const header = ['user_id', 'display_name', 'status', 'token_amount', 'created_at'];
      const lines = [header.join(',')];
      for (const r of rows) {
        const cols = [
          r.user_id,
          (r.user?.display_name || '').replace(/"/g, '""'),
          r.status,
          r.token_amount,
          r.created_at
        ].map((v) => `"${String(v ?? '').replace(/"/g, '""')}"`);
        lines.push(cols.join(','));
      }

      const csv = lines.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `coupon_redemptions_${data.campaign.redeem_code}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // events
    el('logoutBtn').addEventListener('click', (e) => {
      e.preventDefault();
      clearAdminAuthStatus();
      window.location.href = '/admin/login.html';
    });

    el('saveAdminKeyBtn').addEventListener('click', () => {
      const v = el('adminApiKeyInput').value.trim();
      if (!v) {
        toast('è«‹è¼¸å…¥ ADMIN_API_KEY');
        return;
      }
      setAdminApiKey(v);
      toast('âœ… å·²ä¿å­˜');
      loadCampaigns();
    });

    el('refreshBtn').addEventListener('click', () => loadCampaigns());
    el('searchInput').addEventListener('input', () => renderCampaignList());
    el('statusFilter').addEventListener('change', () => renderCampaignList());

    el('openCreateBtn').addEventListener('click', () => openCampaignModal(null));

    el('closeCampaignModal').addEventListener('click', () => closeModal('campaignModal'));
    el('cancelCampaignBtn').addEventListener('click', () => closeModal('campaignModal'));

    el('createCampaignBtn').addEventListener('click', () => createCampaign());
    el('regenerateBtn').addEventListener('click', () => regenerateImage());
    el('deleteCampaignBtn').addEventListener('click', () => deleteCurrentCampaign());

    el('openStatsBtn').addEventListener('click', () => openStats());

    el('copyCodeBtn').addEventListener('click', async () => {
      const code = el('redeemCodeText').textContent;
      if (!code || code === '-') return;
      try {
        await navigator.clipboard.writeText(code);
        toast('âœ… å·²è¤‡è£½');
      } catch {
        toast('è¤‡è£½å¤±æ•—');
      }
    });

    el('closeStatsModal').addEventListener('click', () => closeModal('statsModal'));
    el('closeStatsBtn').addEventListener('click', () => closeModal('statsModal'));
    el('exportCsvBtn').addEventListener('click', () => exportCsv());

    // init
    (function init() {
      const key = getAdminApiKey();
      if (key) {
        state.adminApiKey = key;
        el('adminApiKeyInput').value = key;
      }

      // datetime defaults
      el('startDateInput').value = nowDateForInput();
      el('endDateInput').value = addDaysDateForInput(7);

      loadCampaigns();
    })();
  </script>
</body>
</html>
