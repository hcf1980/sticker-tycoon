<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rich Menu ç®¡ç† - è²¼åœ–å¤§äº¨</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .upload-zone { transition: all 0.2s; }
    .upload-zone:hover { border-color: #FF6B6B; background: #FFF5F5; }
    .upload-zone.dragover { border-color: #FF6B6B; background: #FFE5E5; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-gradient-to-r from-pink-500 to-orange-400 text-white p-4">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-2xl font-bold">ğŸ“± Rich Menu ç®¡ç†</h1>
      <a href="/admin/" class="text-white hover:underline">â† è¿”å›å¾Œå°</a>
    </div>
  </nav>

  <div class="container mx-auto p-6">
    <!-- ä¸‰å€ç¨ç«‹ä¸Šå‚³ -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ–¼ï¸ åˆ†å€ä¸Šå‚³åœ–ç‰‡</h2>
      <p class="text-gray-600 mb-4">åˆ†åˆ¥ä¸Šå‚³ä¸‰å€‹å€åŸŸçš„åœ–ç‰‡ï¼Œç³»çµ±æœƒè‡ªå‹•åˆæˆä¸¦åŠ ä¸Šæ–‡å­—æ¨™ç±¤</p>

      <div class="grid grid-cols-3 gap-4 mb-6">
        <!-- å€åŸŸ 1: å‰µå»ºè²¼åœ– -->
        <div class="text-center">
          <div class="upload-zone border-2 border-dashed border-gray-300 rounded-lg p-4 cursor-pointer relative"
               onclick="document.getElementById('img-1').click()" data-zone="1">
            <input type="file" id="img-1" accept="image/*" class="hidden" onchange="handleZoneUpload(1, this)">
            <img id="preview-1" src="" class="w-full aspect-square object-cover rounded hidden">
            <div id="placeholder-1" class="aspect-square flex flex-col items-center justify-center text-gray-400">
              <span class="text-4xl mb-2">ğŸ¨</span>
              <span class="text-sm">é»æ“Šä¸Šå‚³</span>
            </div>
          </div>
          <div class="mt-2 bg-red-500 text-white py-2 rounded font-bold">å‰µå»ºè²¼åœ–</div>
        </div>

        <!-- å€åŸŸ 2: æˆ‘çš„è²¼åœ– -->
        <div class="text-center">
          <div class="upload-zone border-2 border-dashed border-gray-300 rounded-lg p-4 cursor-pointer relative"
               onclick="document.getElementById('img-2').click()" data-zone="2">
            <input type="file" id="img-2" accept="image/*" class="hidden" onchange="handleZoneUpload(2, this)">
            <img id="preview-2" src="" class="w-full aspect-square object-cover rounded hidden">
            <div id="placeholder-2" class="aspect-square flex flex-col items-center justify-center text-gray-400">
              <span class="text-4xl mb-2">ğŸ“</span>
              <span class="text-sm">é»æ“Šä¸Šå‚³</span>
            </div>
          </div>
          <div class="mt-2 bg-green-500 text-white py-2 rounded font-bold">æˆ‘çš„è²¼åœ–</div>
        </div>

        <!-- å€åŸŸ 3: ç¤ºç¯„åœ–é›† -->
        <div class="text-center">
          <div class="upload-zone border-2 border-dashed border-gray-300 rounded-lg p-4 cursor-pointer relative"
               onclick="document.getElementById('img-3').click()" data-zone="3">
            <input type="file" id="img-3" accept="image/*" class="hidden" onchange="handleZoneUpload(3, this)">
            <img id="preview-3" src="" class="w-full aspect-square object-cover rounded hidden">
            <div id="placeholder-3" class="aspect-square flex flex-col items-center justify-center text-gray-400">
              <span class="text-4xl mb-2">âœ¨</span>
              <span class="text-sm">é»æ“Šä¸Šå‚³</span>
            </div>
          </div>
          <div class="mt-2 bg-blue-500 text-white py-2 rounded font-bold">ç¤ºç¯„åœ–é›†</div>
        </div>
      </div>

      <!-- åˆæˆé è¦½ -->
      <div class="border-t pt-4">
        <h3 class="font-bold text-gray-700 mb-2">ğŸ“ åˆæˆé è¦½ï¼ˆ2500 Ã— 843 pxï¼‰</h3>
        <div class="bg-gray-100 rounded-lg overflow-hidden">
          <canvas id="preview-canvas" width="2500" height="843" class="w-full"></canvas>
        </div>
        <div class="flex items-center justify-between mt-2 text-sm text-gray-500">
          <span id="file-size">é ä¼°æª”æ¡ˆå¤§å°ï¼š--</span>
          <span id="size-status" class="text-green-600">âœ“ ç¬¦åˆä¸Šå‚³é™åˆ¶</span>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰éˆ• -->
      <div class="flex gap-4 mt-6">
        <button onclick="generateAndUpload()" id="upload-btn"
                class="flex-1 bg-pink-500 text-white py-3 rounded-lg hover:bg-pink-600 font-bold disabled:opacity-50">
          ğŸš€ åˆæˆä¸¦æ›´æ–° Rich Menu
        </button>
        <button onclick="resetAll()" class="px-6 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400">
          é‡ç½®
        </button>
      </div>
    </div>

    <!-- ç•¶å‰ Rich Menu -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ ç•¶å‰ Rich Menu</h2>
      <div class="flex flex-col md:flex-row gap-6">
        <div class="flex-1">
          <img id="current-menu-image" src="/rich-menu.png" alt="Rich Menu"
               class="w-full rounded border" onerror="this.style.display='none'">
        </div>
        <div class="flex-1">
          <div class="space-y-3">
            <div>
              <label class="block text-gray-600 text-sm">Rich Menu ID</label>
              <code id="current-menu-id" class="block bg-gray-100 px-3 py-2 rounded text-sm">è¼‰å…¥ä¸­...</code>
            </div>
            <div>
              <label class="block text-gray-600 text-sm">ç‹€æ…‹</label>
              <span class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded text-sm">å·²å•Ÿç”¨</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- èªªæ˜ -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-sm">
      <h3 class="font-bold text-yellow-800 mb-2">ğŸ’¡ ä½¿ç”¨èªªæ˜</h3>
      <ul class="text-yellow-700 space-y-1">
        <li>â€¢ åˆ†åˆ¥ä¸Šå‚³ä¸‰å€‹å€åŸŸçš„åœ–ç‰‡ï¼ˆå»ºè­°æ­£æ–¹å½¢ï¼Œæœƒè‡ªå‹•è£åˆ‡é©æ‡‰ï¼‰</li>
        <li>â€¢ ç³»çµ±æœƒè‡ªå‹•åœ¨åº•éƒ¨åŠ ä¸Šå°æ‡‰çš„æ–‡å­—æ¨™ç±¤</li>
        <li>â€¢ åˆæˆå¾Œçš„åœ–ç‰‡æœƒå£“ç¸®åˆ° 1MB ä»¥å…§ï¼Œç¬¦åˆ LINE è¦æ ¼</li>
        <li>â€¢ é»æ“Šã€Œåˆæˆä¸¦æ›´æ–°ã€å¾Œï¼Œæ‰€æœ‰ç”¨æˆ¶çš„é¸å–®æœƒç«‹å³æ›´æ–°</li>
      </ul>
    </div>
  </div>

  <script>
    const zoneImages = { 1: null, 2: null, 3: null };
    const zoneColors = { 1: '#FF6B6B', 2: '#4CAF50', 3: '#2196F3' };
    const zoneLabels = { 1: 'å‰µå»ºè²¼åœ–', 2: 'æˆ‘çš„è²¼åœ–', 3: 'ç¤ºç¯„åœ–é›†' };
    const zoneIcons = { 1: 'ğŸ¨', 2: 'ğŸ“', 3: 'âœ¨' };

    function handleZoneUpload(zone, input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          zoneImages[zone] = img;
          document.getElementById(`preview-${zone}`).src = e.target.result;
          document.getElementById(`preview-${zone}`).classList.remove('hidden');
          document.getElementById(`placeholder-${zone}`).classList.add('hidden');
          updatePreviewCanvas();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function updatePreviewCanvas() {
      const canvas = document.getElementById('preview-canvas');
      const ctx = canvas.getContext('2d');
      const W = 2500, H = 843;
      const CELL_W = W / 3;
      const TEXT_H = Math.floor(H * 0.25);
      const IMG_H = H - TEXT_H;

      // æ¸…ç©ºç•«å¸ƒ
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, W, H);

      // ç¹ªè£½ä¸‰å€‹å€åŸŸ
      for (let i = 1; i <= 3; i++) {
        const x = (i - 1) * CELL_W;

        // ç¹ªè£½åœ–ç‰‡å€åŸŸ
        if (zoneImages[i]) {
          const img = zoneImages[i];
          const scale = Math.max(CELL_W / img.width, IMG_H / img.height);
          const sw = CELL_W / scale, sh = IMG_H / scale;
          const sx = (img.width - sw) / 2, sy = (img.height - sh) / 2;
          ctx.drawImage(img, sx, sy, sw, sh, x, 0, CELL_W, IMG_H);
        } else {
          // é è¨­èƒŒæ™¯
          ctx.fillStyle = '#F5F5F5';
          ctx.fillRect(x, 0, CELL_W, IMG_H);
          ctx.font = 'bold 150px Arial';
          ctx.textAlign = 'center';
          ctx.fillStyle = '#CCCCCC';
          ctx.fillText(zoneIcons[i], x + CELL_W / 2, IMG_H / 2 + 50);
        }

        // ç¹ªè£½æ–‡å­—å€åŸŸ
        ctx.fillStyle = zoneColors[i];
        ctx.fillRect(x, IMG_H, CELL_W, TEXT_H);

        // ç¹ªè£½æ¨™ç±¤æ–‡å­—
        ctx.font = 'bold 70px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#FFFFFF';
        ctx.fillText(zoneLabels[i], x + CELL_W / 2, IMG_H + TEXT_H / 2);

        // åˆ†éš”ç·š
        if (i < 3) {
          ctx.strokeStyle = '#E0E0E0';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(x + CELL_W, 0);
          ctx.lineTo(x + CELL_W, H);
          ctx.stroke();
        }
      }

      // ä¼°ç®—æª”æ¡ˆå¤§å°ï¼ˆç”¨è¼ƒä½å“è³ªä¼°ç®—ï¼Œå› ç‚ºä¸Šå‚³æ™‚æœƒå£“ç¸®ï¼‰
      canvas.toBlob((blob) => {
        const size = (blob.size / 1024).toFixed(1);
        const sizeEl = document.getElementById('file-size');
        const statusEl = document.getElementById('size-status');
        sizeEl.textContent = `å£“ç¸®å¾Œç´„ï¼š${size} KB`;

        if (blob.size > 700 * 1024) {
          sizeEl.classList.add('text-orange-600');
          sizeEl.classList.remove('text-gray-500');
          statusEl.textContent = 'âš ï¸ æœƒå†å£“ç¸®';
          statusEl.className = 'text-orange-600';
        } else {
          sizeEl.classList.remove('text-orange-600');
          sizeEl.classList.add('text-gray-500');
          statusEl.textContent = 'âœ“ ç¬¦åˆä¸Šå‚³é™åˆ¶';
          statusEl.className = 'text-green-600';
        }
      }, 'image/jpeg', 0.7);
    }

    function resetAll() {
      for (let i = 1; i <= 3; i++) {
        zoneImages[i] = null;
        document.getElementById(`img-${i}`).value = '';
        document.getElementById(`preview-${i}`).classList.add('hidden');
        document.getElementById(`placeholder-${i}`).classList.remove('hidden');
      }
      updatePreviewCanvas();
    }

    // å£“ç¸®åœ–ç‰‡åˆ°æŒ‡å®šå¤§å°ä»¥ä¸‹
    async function compressToSize(canvas, maxBytes, minQuality = 0.3) {
      let quality = 0.85;
      let blob;

      while (quality >= minQuality) {
        blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', quality));
        console.log(`å“è³ª ${quality.toFixed(2)}: ${(blob.size/1024).toFixed(1)} KB`);
        if (blob.size <= maxBytes) return blob;
        quality -= 0.05;
      }

      // æœ€å¾Œå˜—è©¦æœ€ä½å“è³ª
      blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', minQuality));
      if (blob.size <= maxBytes) return blob;

      // å¦‚æœé‚„æ˜¯å¤ªå¤§ï¼Œå˜—è©¦ç¸®å°ç•«å¸ƒå°ºå¯¸
      console.log('å˜—è©¦ç¸®å°å°ºå¯¸...');
      const smallCanvas = document.createElement('canvas');
      smallCanvas.width = 2500;
      smallCanvas.height = 843;
      const ctx = smallCanvas.getContext('2d');
      ctx.drawImage(canvas, 0, 0, 2500, 843);

      blob = await new Promise(r => smallCanvas.toBlob(r, 'image/jpeg', 0.6));
      if (blob.size <= maxBytes) return blob;

      throw new Error(`ç„¡æ³•å£“ç¸®åˆ° ${(maxBytes/1024).toFixed(0)}KB ä»¥ä¸‹ï¼Œè«‹ä½¿ç”¨è¼ƒå°çš„åŸåœ–`);
    }

    async function generateAndUpload() {
      const btn = document.getElementById('upload-btn');
      btn.disabled = true;
      btn.textContent = 'å£“ç¸®ä¸­...';

      try {
        const canvas = document.getElementById('preview-canvas');

        // Netlify Functions body é™åˆ¶ç´„ 1MBï¼Œbase64 ç·¨ç¢¼æœƒå¢åŠ  33%
        // æ‰€ä»¥å¯¦éš›åœ–ç‰‡è¦æ§åˆ¶åœ¨ 700KB ä»¥ä¸‹
        const blob = await compressToSize(canvas, 700 * 1024);
        console.log(`æœ€çµ‚å¤§å°: ${(blob.size/1024).toFixed(1)} KB`);

        btn.textContent = 'ä¸Šå‚³ä¸­...';
        const formData = new FormData();
        formData.append('image', blob, 'rich-menu.jpg');

        const res = await fetch('/api/admin/update-rich-menu', { method: 'POST', body: formData });
        const result = await res.json();

        if (result.success) {
          alert('âœ… Rich Menu æ›´æ–°æˆåŠŸï¼');
          location.reload();
        } else {
          alert('âŒ æ›´æ–°å¤±æ•—ï¼š' + result.error);
        }
      } catch (err) {
        alert('âŒ éŒ¯èª¤ï¼š' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸš€ åˆæˆä¸¦æ›´æ–° Rich Menu';
      }
    }

    // åˆå§‹åŒ–
    updatePreviewCanvas();
    fetch('/api/admin/rich-menu-info').then(r => r.json()).then(data => {
      if (data.richMenuId) document.getElementById('current-menu-id').textContent = data.richMenuId;
    }).catch(() => {});

    // æ‹–æ‹½æ”¯æ´
    document.querySelectorAll('.upload-zone').forEach(zone => {
      zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
      zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const zoneNum = zone.dataset.zone;
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          const input = document.getElementById(`img-${zoneNum}`);
          const dt = new DataTransfer();
          dt.items.add(file);
          input.files = dt.files;
          handleZoneUpload(parseInt(zoneNum), input);
        }
      });
    });
  </script>
</body>
</html>

