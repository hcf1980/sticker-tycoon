<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä»£å¹£ç®¡ç† - è²¼åœ–å¤§äº¨</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .token-card { transition: all 0.2s; }
    .token-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <nav class="bg-yellow-500 text-white p-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold">ğŸ’° ä»£å¹£ç®¡ç†</h1>
      <div>
        <a href="/admin/" class="text-white hover:text-yellow-200 mr-4">â† è¿”å›</a>
        <button onclick="logout()" class="bg-yellow-600 hover:bg-yellow-700 px-3 py-1 rounded">ç™»å‡º</button>
      </div>
    </div>
  </nav>

  <main class="container mx-auto p-4">
    <!-- çµ±è¨ˆå¡ç‰‡ -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg p-4 shadow token-card">
        <div class="text-sm text-gray-500">ç¸½ç”¨æˆ¶æ•¸</div>
        <div class="text-2xl font-bold text-blue-600" id="stat-users">-</div>
      </div>
      <div class="bg-white rounded-lg p-4 shadow token-card">
        <div class="text-sm text-gray-500">ç¸½ä»£å¹£æ•¸</div>
        <div class="text-2xl font-bold text-yellow-600" id="stat-total-tokens">-</div>
      </div>
      <div class="bg-white rounded-lg p-4 shadow token-card">
        <div class="text-sm text-gray-500">ä»Šæ—¥æ¶ˆè€—</div>
        <div class="text-2xl font-bold text-red-600" id="stat-today-spent">-</div>
      </div>
      <div class="bg-white rounded-lg p-4 shadow token-card">
        <div class="text-sm text-gray-500">ä»Šæ—¥å„²å€¼</div>
        <div class="text-2xl font-bold text-green-600" id="stat-today-added">-</div>
      </div>
    </div>

    <!-- æœå°‹ -->
    <div class="bg-white rounded-lg p-4 shadow mb-6">
      <div class="flex gap-4">
        <input type="text" id="search-input" placeholder="æœå°‹ LINE User ID æˆ–é¡¯ç¤ºåç¨±..." 
               class="flex-1 border rounded px-4 py-2" onkeyup="searchUsers()">
        <button onclick="searchUsers()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded">
          ğŸ” æœå°‹
        </button>
      </div>
    </div>

    <!-- ç”¨æˆ¶åˆ—è¡¨ -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
      <div class="p-4 bg-gray-50 border-b">
        <h2 class="font-bold">ğŸ‘¥ ç”¨æˆ¶åˆ—è¡¨</h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-medium text-gray-600">ç”¨æˆ¶</th>
              <th class="px-4 py-3 text-center text-sm font-medium text-gray-600">ä»£å¹£é¤˜é¡</th>
              <th class="px-4 py-3 text-center text-sm font-medium text-gray-600">å‰µå»ºè²¼åœ–</th>
              <th class="px-4 py-3 text-center text-sm font-medium text-gray-600">åŠ å…¥æ—¥æœŸ</th>
              <th class="px-4 py-3 text-center text-sm font-medium text-gray-600">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="user-list" class="divide-y divide-gray-200">
            <tr><td colspan="5" class="text-center py-8 text-gray-500">è¼‰å…¥ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- èª¿æ•´ä»£å¹£ Modal -->
  <div id="adjust-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <h3 class="text-lg font-bold mb-4">ğŸ’° èª¿æ•´ä»£å¹£</h3>
      <input type="hidden" id="adjust-user-id">
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ¶</label>
        <div id="adjust-user-name" class="text-gray-900 font-medium"></div>
        <div id="adjust-user-line-id" class="text-xs text-gray-500"></div>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">ç›®å‰é¤˜é¡</label>
        <div id="adjust-current-balance" class="text-2xl font-bold text-yellow-600"></div>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">èª¿æ•´é¡å‹</label>
        <select id="adjust-type" class="w-full border rounded px-3 py-2">
          <option value="add">â• å¢åŠ ä»£å¹£ï¼ˆå„²å€¼ï¼‰</option>
          <option value="deduct">â– æ‰£é™¤ä»£å¹£</option>
          <option value="set">ğŸ“ è¨­å®šç‚ºæŒ‡å®šæ•¸é‡</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">æ•¸é‡</label>
        <input type="number" id="adjust-amount" class="w-full border rounded px-3 py-2" min="1" value="70">
        <div class="mt-2 flex gap-2 flex-wrap">
          <button onclick="setAmount(70)" class="px-3 py-1 bg-gray-100 rounded text-sm hover:bg-gray-200">70 (NT$300)</button>
          <button onclick="setAmount(130)" class="px-3 py-1 bg-gray-100 rounded text-sm hover:bg-gray-200">130 (NT$500)</button>
          <button onclick="setAmount(300)" class="px-3 py-1 bg-gray-100 rounded text-sm hover:bg-gray-200">300 (NT$1000)</button>
        </div>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
        <input type="text" id="adjust-note" class="w-full border rounded px-3 py-2" placeholder="ä¾‹ï¼šè½‰å¸³å„²å€¼">
      </div>
      <div class="flex gap-2">
        <button onclick="closeAdjustModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded">å–æ¶ˆ</button>
        <button onclick="submitAdjust()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">ç¢ºèªèª¿æ•´</button>
      </div>
    </div>
  </div>

  <script>
    // é©—è­‰ç™»å…¥
    const adminPassword = localStorage.getItem('adminPassword');
    const loginTime = localStorage.getItem('adminLoginTime');
    if (!adminPassword || !loginTime || Date.now() - parseInt(loginTime) > 24*60*60*1000) {
      window.location.href = '/admin/login.html';
    }

    function logout() { localStorage.removeItem('adminPassword'); localStorage.removeItem('adminLoginTime'); window.location.href = '/admin/login.html'; }
    function setAmount(n) { document.getElementById('adjust-amount').value = n; }
    function closeAdjustModal() { document.getElementById('adjust-modal').classList.add('hidden'); }

    let allUsers = [];

    async function loadUsers() {
      try {
        const response = await fetch('/.netlify/functions/admin-token?action=users');
        const result = await response.json();
        if (result.success) {
          allUsers = result.users;
          renderUserList(allUsers);
          updateStats(result.stats);
        }
      } catch (err) {
        console.error('è¼‰å…¥ç”¨æˆ¶å¤±æ•—:', err);
        document.getElementById('user-list').innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">è¼‰å…¥å¤±æ•—</td></tr>';
      }
    }

    function updateStats(stats) {
      document.getElementById('stat-users').textContent = stats.totalUsers || 0;
      document.getElementById('stat-total-tokens').textContent = stats.totalTokens || 0;
      document.getElementById('stat-today-spent').textContent = stats.todaySpent || 0;
      document.getElementById('stat-today-added').textContent = stats.todayAdded || 0;
    }

    function searchUsers() {
      const search = document.getElementById('search-input').value.toLowerCase();
      const filtered = allUsers.filter(u =>
        (u.line_user_id && u.line_user_id.toLowerCase().includes(search)) ||
        (u.display_name && u.display_name.toLowerCase().includes(search))
      );
      renderUserList(filtered);
    }

    function renderUserList(users) {
      if (!users || users.length === 0) {
        document.getElementById('user-list').innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">æ²’æœ‰æ‰¾åˆ°ç”¨æˆ¶</td></tr>';
        return;
      }
      document.getElementById('user-list').innerHTML = users.map(u => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">
            <div class="font-medium">${u.display_name || 'æœªçŸ¥ç”¨æˆ¶'}</div>
            <div class="text-xs text-gray-500">${u.line_user_id ? u.line_user_id.substring(0, 20) + '...' : '-'}</div>
          </td>
          <td class="px-4 py-3 text-center">
            <span class="text-xl font-bold ${u.sticker_credits > 10 ? 'text-green-600' : u.sticker_credits > 0 ? 'text-yellow-600' : 'text-red-600'}">${u.sticker_credits || 0}</span>
          </td>
          <td class="px-4 py-3 text-center text-gray-600">${u.sticker_count || 0} çµ„</td>
          <td class="px-4 py-3 text-center text-sm text-gray-500">${u.created_at ? new Date(u.created_at).toLocaleDateString('zh-TW') : '-'}</td>
          <td class="px-4 py-3 text-center">
            <button onclick="openAdjustModal('${u.line_user_id}', '${u.display_name || 'æœªçŸ¥'}', ${u.sticker_credits || 0})"
                    class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">
              èª¿æ•´ä»£å¹£
            </button>
          </td>
        </tr>
      `).join('');
    }

    function openAdjustModal(lineUserId, name, balance) {
      document.getElementById('adjust-user-id').value = lineUserId;
      document.getElementById('adjust-user-name').textContent = name;
      document.getElementById('adjust-user-line-id').textContent = lineUserId;
      document.getElementById('adjust-current-balance').textContent = balance;
      document.getElementById('adjust-modal').classList.remove('hidden');
    }

    async function submitAdjust() {
      const lineUserId = document.getElementById('adjust-user-id').value;
      const type = document.getElementById('adjust-type').value;
      const amount = parseInt(document.getElementById('adjust-amount').value);
      const note = document.getElementById('adjust-note').value;

      if (!amount || amount < 1) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸é‡');
        return;
      }

      try {
        const response = await fetch('/.netlify/functions/admin-token?action=adjust', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lineUserId, type, amount, note })
        });
        const result = await response.json();
        if (result.success) {
          alert(`âœ… èª¿æ•´æˆåŠŸï¼æ–°é¤˜é¡ï¼š${result.newBalance}`);
          closeAdjustModal();
          loadUsers();
        } else {
          alert('âŒ èª¿æ•´å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
        }
      } catch (err) {
        alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message);
      }
    }

    // åˆå§‹è¼‰å…¥
    loadUsers();
  </script>
</body>
</html>

