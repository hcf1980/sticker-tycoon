<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾…ä¸Šå‚³ä½‡åˆ— - è²¼åœ–å¤§äº¨</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; padding-bottom: 160px; }
    .header { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
    .header.ready { background: linear-gradient(135deg, #06C755 0%, #05A847 100%); }
    .header h1 { font-size: 1.5rem; margin-bottom: 8px; }
    .progress-info { display: flex; justify-content: center; align-items: center; gap: 10px; }
    .progress-bar { width: 200px; height: 10px; background: rgba(255,255,255,0.3); border-radius: 5px; overflow: hidden; }
    .progress-fill { height: 100%; background: white; transition: width 0.3s; }
    .count { font-size: 1.2rem; font-weight: bold; }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    .section-title { font-size: 1.1rem; font-weight: 600; margin: 20px 0 10px; color: #333; display: flex; align-items: center; gap: 8px; }
    .cover-section { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .cover-preview { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    .cover-box { text-align: center; }
    .cover-box img { border-radius: 8px; border: 2px solid #ddd; background: #f9f9f9; }
    .cover-box p { font-size: 0.75rem; color: #666; margin-top: 5px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
    .sticker-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
    .sticker-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .sticker-card.selected { border: 3px solid #06C755; }
    .sticker-card.selected::after { content: 'âœ“ å°é¢'; position: absolute; top: 8px; right: 8px; background: #06C755; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
    .sticker-img { width: 100%; aspect-ratio: 1; object-fit: contain; background: #f9f9f9; padding: 8px; }
    .sticker-info { padding: 8px; text-align: center; border-top: 1px solid #eee; }
    .sticker-name { font-size: 0.8rem; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sticker-num { font-size: 0.7rem; color: #999; margin-top: 2px; }
    .actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    .actions-inner { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; }
    .btn-row { display: flex; gap: 10px; }
    .btn { flex: 1; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: #06C755; color: white; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .btn-secondary { background: #eee; color: #333; }
    .btn-danger { background: #ffebee; color: #d32f2f; }
    .hint { font-size: 0.8rem; color: #666; text-align: center; }
    .empty { text-align: center; padding: 60px 20px; color: #666; }
    .empty-icon { font-size: 4rem; margin-bottom: 20px; }
    .loading { text-align: center; padding: 60px; color: #666; }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: #FF9800; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 200; opacity: 0; transition: opacity 0.3s; }
    .toast.show { opacity: 1; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; text-align: center; }
    .modal-content h3 { margin-bottom: 15px; }
    .modal-content p { color: #666; margin-bottom: 20px; font-size: 0.9rem; }
    .modal-btns { display: flex; gap: 10px; }
    .modal-btns .btn { flex: 1; }
    @media (max-width: 480px) { .grid { grid-template-columns: repeat(3, 1fr); gap: 8px; } .cover-preview { justify-content: center; } }
  </style>
</head>
<body>
  <div class="header" id="header">
    <h1>ğŸ“¤ LINE è²¼åœ–ä¸Šæ¶æº–å‚™</h1>
    <div class="progress-info">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <span class="count" id="countText">0 / 40</span>
    </div>
  </div>

  <div class="container">
    <div id="content">
      <div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div>
    </div>
  </div>

  <div class="actions">
    <div class="actions-inner">
      <p class="hint" id="hintText">ğŸ‘† é»æ“Šä»»ä¸€å¼µè²¼åœ–è¨­ç‚ºå°é¢åœ–ç‰‡</p>
      <div class="token-info" id="tokenInfo" style="background:#fff3e0;padding:8px 12px;border-radius:8px;margin-bottom:10px;font-size:0.85rem;text-align:center;">
        ğŸ’° æ‚¨çš„ä»£å¹£ï¼š<strong id="userTokens">è¼‰å…¥ä¸­...</strong> æš | ğŸ“¦ ä¸‹è¼‰/ä¸Šæ¶éœ€æ¶ˆè€— <strong style="color:#d32f2f;">40 ä»£å¹£</strong>
      </div>
      <div class="btn-row">
        <button class="btn btn-danger" onclick="showClearModal()">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button class="btn btn-secondary" id="downloadBtn" disabled onclick="showDownloadConfirm()">ğŸ“¥ è‡ªè¡Œä¸Šæ¶<br><small style="font-size:0.7rem;opacity:0.8;">æ‰£ 40 ä»£å¹£</small></button>
        <button class="btn btn-primary" id="submitBtn" disabled onclick="showSubmitModal()">ğŸš€ å…è²»ä»£ä¸Šæ¶<br><small style="font-size:0.7rem;opacity:0.9;">æ‰£ 40 ä»£å¹£</small></button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- æ¸…ç©ºç¢ºèªå½ˆçª— -->
  <div class="modal" id="clearModal">
    <div class="modal-content">
      <h3>ğŸ—‘ï¸ ç¢ºå®šæ¸…ç©ºï¼Ÿ</h3>
      <p>å°‡ç§»é™¤æ‰€æœ‰ 40 å¼µè²¼åœ–ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
      <div class="modal-btns">
        <button class="btn btn-secondary" onclick="hideModal()">å–æ¶ˆ</button>
        <button class="btn btn-danger" onclick="clearAll()">ç¢ºå®šæ¸…ç©º</button>
      </div>
    </div>
  </div>

  <!-- ä¸‹è¼‰ç¢ºèªå½ˆçª— -->
  <div class="modal" id="downloadConfirmModal">
    <div class="modal-content">
      <h3>ğŸ“¥ ç¢ºèªä¸‹è¼‰è²¼åœ–åŒ…ï¼Ÿ</h3>
      <div style="background:#fff3e0;padding:15px;border-radius:10px;margin:15px 0;">
        <p style="font-size:1.1rem;margin-bottom:10px;">ğŸ’° å°‡æ¶ˆè€— <strong style="color:#d32f2f;font-size:1.3rem;">40 ä»£å¹£</strong></p>
        <p style="font-size:0.85rem;color:#666;">æ‚¨ç›®å‰æœ‰ <strong id="confirmTokens">-</strong> æšä»£å¹£</p>
      </div>
      <p style="font-size:0.8rem;color:#666;margin-bottom:15px;">ä¸‹è¼‰å¾Œæ‚¨å°‡ç²å¾—ç¬¦åˆ LINE è¦æ ¼çš„å®Œæ•´è²¼åœ–åŒ…ï¼ˆZIPï¼‰</p>
      <div class="modal-btns">
        <button class="btn btn-secondary" onclick="hideDownloadConfirm()">å–æ¶ˆ</button>
        <button class="btn btn-primary" id="confirmDownloadBtn" onclick="download()">âœ… ç¢ºèªä¸‹è¼‰</button>
      </div>
    </div>
  </div>

  <!-- ä¸‹è¼‰ä¸­å½ˆçª— -->
  <div class="modal" id="downloadModal">
    <div class="modal-content">
      <div class="spinner"></div>
      <h3>ğŸ“¦ æ­£åœ¨æ‰“åŒ…...</h3>
      <p>æ­£åœ¨è™•ç† 40 å¼µè²¼åœ–ï¼Œè«‹ç¨å€™ç´„ 1-2 åˆ†é˜...</p>
    </div>
  </div>

  <!-- å…è²»ä»£ä¸Šæ¶å½ˆçª— -->
  <div class="modal" id="submitModal">
    <div class="modal-content" style="max-width:450px;text-align:left;">
      <h3 style="text-align:center;margin-bottom:20px;">ğŸš€ å…è²»ä»£ä¸Šæ¶æœå‹™</h3>
      <div style="background:#fff3e0;padding:12px;border-radius:8px;font-size:0.85rem;margin-bottom:15px;border:2px solid #ffcc80;">
        ğŸ’° <strong>æ¶ˆè€—ä»£å¹£ï¼š</strong><span style="color:#d32f2f;font-weight:bold;font-size:1.1rem;">40 ä»£å¹£</span><br>
        <span style="font-size:0.8rem;color:#666;">æ‚¨ç›®å‰æœ‰ <strong id="submitTokens">-</strong> æšä»£å¹£</span>
      </div>
      <p style="background:#e8f5e9;padding:12px;border-radius:8px;font-size:0.85rem;margin-bottom:15px;">
        âœ… ä»£ä¸Šæ¶æœå‹™å…è²»ï¼åƒ…éœ€æ”¯ä»˜è²¼åœ–è£½ä½œä»£å¹£<br>
        â±ï¸ å¯©æ ¸æ™‚é–“ç´„ 3-7 å€‹å·¥ä½œå¤©
      </p>
      <div style="margin-bottom:15px;">
        <label style="font-weight:600;font-size:0.9rem;display:block;margin-bottom:5px;">è²¼åœ–è‹±æ–‡åç¨± *</label>
        <input type="text" id="stickerNameEn" placeholder="ä¾‹å¦‚ï¼šMy Daily Life" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:1rem;">
        <p style="font-size:0.75rem;color:#666;margin-top:5px;">LINE è²¼åœ–å°èˆ–é¡¯ç¤ºçš„åç¨±ï¼ˆè‹±æ–‡ï¼‰</p>
      </div>
      <div style="margin-bottom:15px;">
        <label style="font-weight:600;font-size:0.9rem;display:block;margin-bottom:5px;">è²¼åœ–ä¸­æ–‡åç¨±</label>
        <input type="text" id="stickerNameZh" placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„æ—¥å¸¸" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:8px;font-size:1rem;">
      </div>
      <div style="margin-bottom:15px;">
        <label style="font-weight:600;font-size:0.9rem;display:block;margin-bottom:8px;">ğŸ’° é¸æ“‡å”®åƒ¹</label>
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;" id="priceOptions">
          <button class="price-btn selected" data-price="30" onclick="selectPrice(30)">NT$30</button>
          <button class="price-btn" data-price="60" onclick="selectPrice(60)">NT$60</button>
          <button class="price-btn" data-price="90" onclick="selectPrice(90)">NT$90</button>
          <button class="price-btn" data-price="120" onclick="selectPrice(120)">NT$120</button>
          <button class="price-btn" data-price="150" onclick="selectPrice(150)">NT$150</button>
        </div>
        <p style="font-size:0.75rem;color:#666;margin-top:8px;">ğŸ’¡ å”®åƒ¹è¶Šé«˜ï¼Œæ¯æ¬¡éŠ·å”®æ‚¨ç²å¾—çš„åˆ†æ½¤è¶Šå¤š</p>
      </div>
      <div style="background:#fff3e0;padding:12px;border-radius:8px;font-size:0.8rem;margin-bottom:20px;">
        ğŸ“Œ <strong>æ³¨æ„äº‹é …ï¼š</strong><br>
        â€¢ è²¼åœ–å°‡ç”± Sticker Tycoon çµ±ä¸€ä¸Šæ¶<br>
        â€¢ éŠ·å”®åˆ†æ½¤ä¾ LINE å®˜æ–¹è¦å®šè¨ˆç®—<br>
        â€¢ ä¸Šæ¶å¾Œæœƒé€é LINE é€šçŸ¥æ‚¨
      </div>
      <div class="modal-btns">
        <button class="btn btn-secondary" onclick="hideSubmitModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="submitForReview()">ğŸš€ æäº¤ä¸Šæ¶ç”³è«‹</button>
      </div>
    </div>
  </div>

  <style>
    .price-btn { padding:10px 5px; border:2px solid #ddd; border-radius:8px; background:white; font-size:0.9rem; cursor:pointer; transition:all 0.2s; }
    .price-btn:hover { border-color:#06C755; }
    .price-btn.selected { border-color:#06C755; background:#e8f5e9; font-weight:600; }
  </style>

  <script>
    const API_BASE = '/.netlify/functions';
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    let queue = [];
    let selectedCoverIndex = 0;
    let selectedPrice = 30;
    let userTokens = 0;
    const DOWNLOAD_COST = 40;  // ä¸‹è¼‰/ä¸Šæ¶æ‰€éœ€ä»£å¹£

    async function loadQueue() {
      if (!userId) { showEmpty('è«‹å¾ LINE é–‹å•Ÿæ­¤é é¢'); return; }
      try {
        const res = await fetch(`${API_BASE}/get-upload-queue?userId=${encodeURIComponent(userId)}`);
        const data = await res.json();
        if (data.success) { queue = data.queue || []; renderQueue(); loadUserTokens(); }
        else { showEmpty('è¼‰å…¥å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤')); }
      } catch (e) { showEmpty('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦'); }
    }

    async function loadUserTokens() {
      try {
        const res = await fetch(`${API_BASE}/get-tokens?userId=${encodeURIComponent(userId)}`);
        const data = await res.json();
        if (data.success) {
          userTokens = data.balance || 0;
          updateTokenDisplay();
        }
      } catch (e) { console.error('è¼‰å…¥ä»£å¹£å¤±æ•—', e); }
    }

    function updateTokenDisplay() {
      const tokenEl = document.getElementById('userTokens');
      const confirmEl = document.getElementById('confirmTokens');
      const submitEl = document.getElementById('submitTokens');
      const hasEnough = userTokens >= DOWNLOAD_COST;

      if (tokenEl) {
        tokenEl.textContent = userTokens;
        tokenEl.style.color = hasEnough ? '#06C755' : '#d32f2f';
      }
      if (confirmEl) {
        confirmEl.textContent = userTokens;
        confirmEl.style.color = hasEnough ? '#06C755' : '#d32f2f';
      }
      if (submitEl) {
        submitEl.textContent = userTokens;
        submitEl.style.color = hasEnough ? '#06C755' : '#d32f2f';
      }

      // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
      const downloadBtn = document.getElementById('downloadBtn');
      const submitBtn = document.getElementById('submitBtn');
      const confirmDownloadBtn = document.getElementById('confirmDownloadBtn');

      if (queue.length >= 40 && !hasEnough) {
        if (downloadBtn) downloadBtn.title = 'ä»£å¹£ä¸è¶³';
        if (submitBtn) submitBtn.title = 'ä»£å¹£ä¸è¶³';
      }
    }

    function renderQueue() {
      const count = queue.length;
      const isReady = count >= 40;
      document.getElementById('header').className = 'header' + (isReady ? ' ready' : '');
      document.getElementById('countText').textContent = `${count} / 40`;
      document.getElementById('progressFill').style.width = `${(count/40)*100}%`;
      document.getElementById('downloadBtn').disabled = !isReady;
      document.getElementById('submitBtn').disabled = !isReady;
      document.getElementById('hintText').textContent = isReady
        ? 'âœ… å·²æ»¿ 40 å¼µï¼é»æ“Šè²¼åœ–è¨­ç‚ºå°é¢ï¼Œç„¶å¾Œä¸‹è¼‰'
        : `â³ é‚„éœ€è¦ ${40-count} å¼µè²¼åœ–`;

      if (count === 0) { showEmpty('ä½‡åˆ—æ˜¯ç©ºçš„ï¼Œè«‹å…ˆåœ¨ LINE ä¸­é¸æ“‡è²¼åœ–'); return; }

      // å°é¢é è¦½å€
      let html = '';
      if (isReady) {
        const cover = queue[selectedCoverIndex];
        html += `<div class="cover-section">
          <div class="section-title">ğŸ“¸ å°é¢é è¦½ï¼ˆLINE è¦æ ¼ï¼‰</div>
          <div class="cover-preview">
            <div class="cover-box">
              <img src="${cover.image_url}" width="120" height="120" style="object-fit:contain;">
              <p>ä¸»è¦åœ–ç‰‡ 240Ã—240</p>
            </div>
            <div class="cover-box">
              <img src="${cover.image_url}" width="96" height="74" style="object-fit:contain;">
              <p>æ¨™ç±¤åœ–ç‰‡ 96Ã—74</p>
            </div>
            <div style="flex:1;font-size:0.85rem;color:#666;">
              <p><strong>å°é¢ï¼š</strong>${cover.expression || 'è²¼åœ– '+(selectedCoverIndex+1)}</p>
              <p style="margin-top:5px;">é»æ“Šä¸‹æ–¹ä»»ä¸€å¼µè²¼åœ–å¯æ›´æ›å°é¢</p>
            </div>
          </div>
        </div>`;
      }

      html += '<div class="section-title">ğŸ–¼ï¸ è²¼åœ–åˆ—è¡¨ï¼ˆ40å¼µï¼‰</div>';
      html += '<div class="grid">';
      queue.forEach((item, i) => {
        const isSelected = i === selectedCoverIndex;
        html += `<div class="sticker-card${isSelected ? ' selected' : ''}" onclick="selectCover(${i})">
          <img class="sticker-img" src="${item.image_url}" alt="è²¼åœ– ${i+1}">
          <div class="sticker-info">
            <div class="sticker-name">${item.expression || 'è²¼åœ–'}</div>
            <div class="sticker-num">#${String(i+1).padStart(2,'0')}</div>
          </div>
        </div>`;
      });
      html += '</div>';
      document.getElementById('content').innerHTML = html;
    }

    function selectCover(index) {
      selectedCoverIndex = index;
      renderQueue();
      showToast(`å·²é¸æ“‡ #${index+1} ç‚ºå°é¢`);
    }

    function showEmpty(msg) {
      document.getElementById('content').innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“‹</div><p>${msg}</p></div>`;
    }

    function showClearModal() {
      document.getElementById('clearModal').classList.add('show');
    }

    function hideModal() {
      document.getElementById('clearModal').classList.remove('show');
    }

    function showDownloadConfirm() {
      if (userTokens < DOWNLOAD_COST) {
        showToast(`âŒ ä»£å¹£ä¸è¶³ï¼éœ€è¦ ${DOWNLOAD_COST} æšï¼Œæ‚¨åªæœ‰ ${userTokens} æš`);
        return;
      }
      document.getElementById('confirmTokens').textContent = userTokens;
      document.getElementById('downloadConfirmModal').classList.add('show');
    }

    function hideDownloadConfirm() {
      document.getElementById('downloadConfirmModal').classList.remove('show');
    }

    async function clearAll() {
      hideModal();
      try {
        const res = await fetch(`${API_BASE}/clear-queue`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });
        const data = await res.json();
        if (data.success) { queue = []; selectedCoverIndex = 0; renderQueue(); showToast('å·²æ¸…ç©º'); }
        else { showToast('æ¸…ç©ºå¤±æ•—'); }
      } catch (e) { showToast('æ“ä½œå¤±æ•—'); }
    }

    async function download() {
      hideDownloadConfirm();

      // å†æ¬¡æª¢æŸ¥ä»£å¹£
      if (userTokens < DOWNLOAD_COST) {
        showToast(`âŒ ä»£å¹£ä¸è¶³ï¼éœ€è¦ ${DOWNLOAD_COST} æš`);
        return;
      }
      const modal = document.getElementById('downloadModal');
      const modalContent = modal.querySelector('.modal-content');
      modal.classList.add('show');

      try {
        // å•Ÿå‹•æ‰“åŒ…ä»»å‹™
        const startRes = await fetch(`${API_BASE}/pack-for-line`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, mainIndex: selectedCoverIndex })
        });
        const startData = await startRes.json();

        if (!startRes.ok) {
          throw new Error(startData.error || 'å•Ÿå‹•å¤±æ•—');
        }

        showToast('ğŸ“¦ é–‹å§‹æ‰“åŒ…...');

        // è¼ªè©¢æª¢æŸ¥ç‹€æ…‹
        let attempts = 0;
        const maxAttempts = 120; // æœ€å¤šç­‰ 2 åˆ†é˜

        while (attempts < maxAttempts) {
          await new Promise(r => setTimeout(r, 1000)); // æ¯ç§’æª¢æŸ¥ä¸€æ¬¡

          const statusRes = await fetch(`${API_BASE}/pack-for-line?userId=${encodeURIComponent(userId)}&action=status`);
          const status = await statusRes.json();

          // æ›´æ–°é€²åº¦
          if (status.progress) {
            modalContent.innerHTML = `
              <div class="spinner"></div>
              <h3>ğŸ“¦ æ‰“åŒ…ä¸­... ${status.progress}%</h3>
              <div style="width:100%;height:8px;background:#eee;border-radius:4px;margin:10px 0;">
                <div style="width:${status.progress}%;height:100%;background:#06C755;border-radius:4px;transition:width 0.3s;"></div>
              </div>
              <p>æ­£åœ¨è™•ç† 40 å¼µè²¼åœ–ä¸¦ä¸Šå‚³...</p>
            `;
          }

          if (status.status === 'completed' && status.downloadUrl) {
            // å®Œæˆï¼é–‹å§‹ä¸‹è¼‰
            modal.classList.remove('show');
            showToast('âœ… æ‰“åŒ…å®Œæˆï¼é–‹å§‹ä¸‹è¼‰...');

            // ç›´æ¥é–‹å•Ÿä¸‹è¼‰é€£çµ
            const a = document.createElement('a');
            a.href = status.downloadUrl;
            a.download = 'line_stickers.zip';
            a.target = '_blank';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            setTimeout(() => {
              if (confirm('ä¸‹è¼‰å®Œæˆï¼æ˜¯å¦å‰å¾€ LINE Creators Market ä¸Šå‚³è²¼åœ–ï¼Ÿ')) {
                window.open('https://creator.line.me/my/', '_blank');
              }
            }, 1000);
            return;
          }

          if (status.status === 'failed') {
            throw new Error(status.error || 'æ‰“åŒ…å¤±æ•—');
          }

          attempts++;
        }

        throw new Error('æ‰“åŒ…é€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦');

      } catch (e) {
        modal.classList.remove('show');
        showToast('âŒ ' + e.message);
      }
    }

    function showToast(msg) {
      const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    function showSubmitModal() {
      if (userTokens < DOWNLOAD_COST) {
        showToast(`âŒ ä»£å¹£ä¸è¶³ï¼éœ€è¦ ${DOWNLOAD_COST} æšï¼Œæ‚¨åªæœ‰ ${userTokens} æš`);
        return;
      }
      document.getElementById('submitTokens').textContent = userTokens;
      document.getElementById('submitModal').classList.add('show');
    }

    function hideSubmitModal() {
      document.getElementById('submitModal').classList.remove('show');
    }

    function selectPrice(price) {
      selectedPrice = price;
      document.querySelectorAll('.price-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.dataset.price) === price);
      });
    }

    async function submitForReview() {
      const nameEn = document.getElementById('stickerNameEn').value.trim();
      const nameZh = document.getElementById('stickerNameZh').value.trim();

      if (!nameEn) {
        showToast('âŒ è«‹è¼¸å…¥è²¼åœ–è‹±æ–‡åç¨±');
        return;
      }

      // å†æ¬¡æª¢æŸ¥ä»£å¹£
      if (userTokens < DOWNLOAD_COST) {
        showToast(`âŒ ä»£å¹£ä¸è¶³ï¼éœ€è¦ ${DOWNLOAD_COST} æš`);
        return;
      }

      hideSubmitModal();
      const modal = document.getElementById('downloadModal');
      const modalContent = modal.querySelector('.modal-content');
      modalContent.innerHTML = `<div class="spinner"></div><h3>ğŸš€ æ­£åœ¨æäº¤ç”³è«‹...</h3><p>è«‹ç¨å€™...</p>`;
      modal.classList.add('show');

      try {
        const res = await fetch(`${API_BASE}/submit-for-listing`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId,
            nameEn,
            nameZh,
            price: selectedPrice,
            coverIndex: selectedCoverIndex,
            stickerCount: queue.length
          })
        });
        const data = await res.json();

        if (!res.ok || !data.success) {
          throw new Error(data.error || 'æäº¤å¤±æ•—');
        }

        modal.classList.remove('show');
        showToast('âœ… ç”³è«‹å·²æäº¤ï¼');

        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        setTimeout(() => {
          alert(`ğŸ‰ ä¸Šæ¶ç”³è«‹å·²æäº¤ï¼\n\nğŸ“‹ ç”³è«‹ç·¨è™Ÿï¼š${data.applicationId}\nğŸ“¦ è²¼åœ–åç¨±ï¼š${nameEn}\nğŸ’° å”®åƒ¹ï¼šNT$${selectedPrice}\n\nâ±ï¸ é è¨ˆ 3-7 å€‹å·¥ä½œå¤©å®Œæˆä¸Šæ¶\nğŸ“± ä¸Šæ¶å¾Œæœƒé€é LINE é€šçŸ¥æ‚¨`);
        }, 500);

      } catch (e) {
        modal.classList.remove('show');
        showToast('âŒ ' + e.message);
      }
    }

    loadQueue();
  </script>
</body>
</html>

