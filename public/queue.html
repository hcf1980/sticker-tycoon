<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾…ä¸Šå‚³ä½‡åˆ— - è²¼åœ–å¤§äº¨</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
    .header { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
    .header.ready { background: linear-gradient(135deg, #06C755 0%, #05A847 100%); }
    .header h1 { font-size: 1.5rem; margin-bottom: 8px; }
    .progress-info { display: flex; justify-content: center; align-items: center; gap: 10px; }
    .progress-bar { width: 200px; height: 10px; background: rgba(255,255,255,0.3); border-radius: 5px; overflow: hidden; }
    .progress-fill { height: 100%; background: white; transition: width 0.3s; }
    .count { font-size: 1.2rem; font-weight: bold; }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
    .sticker-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .sticker-img { width: 100%; aspect-ratio: 1; object-fit: contain; background: #f9f9f9; padding: 10px; }
    .sticker-info { padding: 10px; text-align: center; }
    .sticker-name { font-size: 0.85rem; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sticker-num { font-size: 0.75rem; color: #999; margin-top: 4px; }
    .remove-btn { width: 100%; padding: 8px; border: none; background: #fee; color: #d32f2f; font-size: 0.8rem; cursor: pointer; transition: background 0.2s; }
    .remove-btn:hover { background: #ffcdd2; }
    .actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; gap: 10px; justify-content: center; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600; }
    .btn-primary { background: #06C755; color: white; }
    .btn-primary:disabled { background: #ccc; }
    .btn-secondary { background: #eee; color: #333; }
    .empty { text-align: center; padding: 60px 20px; color: #666; }
    .empty-icon { font-size: 4rem; margin-bottom: 20px; }
    .loading { text-align: center; padding: 60px; color: #666; }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: #FF9800; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 200; opacity: 0; transition: opacity 0.3s; }
    .toast.show { opacity: 1; }
    @media (max-width: 480px) { .grid { grid-template-columns: repeat(3, 1fr); gap: 10px; } .sticker-info { padding: 8px; } }
  </style>
</head>
<body>
  <div class="header" id="header">
    <h1>ğŸ“¤ å¾…ä¸Šå‚³ä½‡åˆ—</h1>
    <div class="progress-info">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <span class="count" id="countText">0 / 40</span>
    </div>
  </div>
  
  <div class="container">
    <div id="content">
      <div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div>
    </div>
  </div>
  
  <div class="actions">
    <button class="btn btn-secondary" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©º</button>
    <button class="btn btn-primary" id="downloadBtn" disabled onclick="download()">ğŸ“¥ ä¸‹è¼‰è²¼åœ–åŒ…</button>
  </div>
  
  <div class="toast" id="toast"></div>

  <script>
    const API_BASE = '/.netlify/functions';
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    let queue = [];

    async function loadQueue() {
      if (!userId) { showEmpty('è«‹å¾ LINE é–‹å•Ÿæ­¤é é¢'); return; }
      try {
        const res = await fetch(`${API_BASE}/get-upload-queue?userId=${encodeURIComponent(userId)}`);
        const data = await res.json();
        if (data.success) { queue = data.queue || []; renderQueue(); }
        else { showEmpty('è¼‰å…¥å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤')); }
      } catch (e) { showEmpty('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦'); }
    }

    function renderQueue() {
      const count = queue.length;
      const isReady = count >= 40;
      document.getElementById('header').className = 'header' + (isReady ? ' ready' : '');
      document.getElementById('countText').textContent = `${count} / 40`;
      document.getElementById('progressFill').style.width = `${(count/40)*100}%`;
      document.getElementById('downloadBtn').disabled = !isReady;
      
      if (count === 0) { showEmpty('ä½‡åˆ—æ˜¯ç©ºçš„ï¼Œè«‹å…ˆåœ¨ LINE ä¸­é¸æ“‡è²¼åœ–'); return; }
      
      let html = '<div class="grid">';
      queue.forEach((item, i) => {
        html += `<div class="sticker-card">
          <img class="sticker-img" src="${item.image_url}" alt="è²¼åœ– ${i+1}">
          <div class="sticker-info">
            <div class="sticker-name">${item.expression || 'è²¼åœ– '+(i+1)}</div>
            <div class="sticker-num">#${i+1}</div>
          </div>
          <button class="remove-btn" onclick="remove('${item.sticker_id}')">âŒ ç§»é™¤</button>
        </div>`;
      });
      html += '</div>';
      document.getElementById('content').innerHTML = html;
    }

    function showEmpty(msg) {
      document.getElementById('content').innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“‹</div><p>${msg}</p></div>`;
    }

    async function remove(stickerId) {
      try {
        const res = await fetch(`${API_BASE}/remove-from-queue`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId, stickerId })
        });
        const data = await res.json();
        if (data.success) { queue = queue.filter(q => q.sticker_id !== stickerId); renderQueue(); showToast('å·²ç§»é™¤'); }
        else { showToast('ç§»é™¤å¤±æ•—'); }
      } catch (e) { showToast('æ“ä½œå¤±æ•—'); }
    }

    async function clearAll() {
      if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è²¼åœ–å—ï¼Ÿ')) return;
      try {
        const res = await fetch(`${API_BASE}/clear-queue`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });
        const data = await res.json();
        if (data.success) { queue = []; renderQueue(); showToast('å·²æ¸…ç©º'); }
        else { showToast('æ¸…ç©ºå¤±æ•—'); }
      } catch (e) { showToast('æ“ä½œå¤±æ•—'); }
    }

    function download() {
      showToast('æ­£åœ¨æº–å‚™ä¸‹è¼‰...');
      window.location.href = `${API_BASE}/download-pack?userId=${encodeURIComponent(userId)}`;
    }

    function showToast(msg) {
      const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    loadQueue();
  </script>
</body>
</html>

