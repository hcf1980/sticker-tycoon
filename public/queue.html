<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾…ä¸Šå‚³ä½‡åˆ— - è²¼åœ–å¤§äº¨</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; padding-bottom: 160px; }
    .header { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; padding: 20px; text-align: center; position: sticky; top: 0; z-index: 100; }
    .header.ready { background: linear-gradient(135deg, #06C755 0%, #05A847 100%); }
    .header h1 { font-size: 1.5rem; margin-bottom: 8px; }
    .progress-info { display: flex; justify-content: center; align-items: center; gap: 10px; }
    .progress-bar { width: 200px; height: 10px; background: rgba(255,255,255,0.3); border-radius: 5px; overflow: hidden; }
    .progress-fill { height: 100%; background: white; transition: width 0.3s; }
    .count { font-size: 1.2rem; font-weight: bold; }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    .section-title { font-size: 1.1rem; font-weight: 600; margin: 20px 0 10px; color: #333; display: flex; align-items: center; gap: 8px; }
    .cover-section { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .cover-preview { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
    .cover-box { text-align: center; }
    .cover-box img { border-radius: 8px; border: 2px solid #ddd; background: #f9f9f9; }
    .cover-box p { font-size: 0.75rem; color: #666; margin-top: 5px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
    .sticker-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative; }
    .sticker-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .sticker-card.selected { border: 3px solid #06C755; }
    .sticker-card.selected::after { content: 'âœ“ å°é¢'; position: absolute; top: 8px; right: 8px; background: #06C755; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; }
    .sticker-img { width: 100%; aspect-ratio: 1; object-fit: contain; background: #f9f9f9; padding: 8px; }
    .sticker-info { padding: 8px; text-align: center; border-top: 1px solid #eee; }
    .sticker-name { font-size: 0.8rem; font-weight: 600; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sticker-num { font-size: 0.7rem; color: #999; margin-top: 2px; }
    .actions { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
    .actions-inner { max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; }
    .btn-row { display: flex; gap: 10px; }
    .btn { flex: 1; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: #06C755; color: white; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .btn-secondary { background: #eee; color: #333; }
    .btn-danger { background: #ffebee; color: #d32f2f; }
    .hint { font-size: 0.8rem; color: #666; text-align: center; }
    .empty { text-align: center; padding: 60px 20px; color: #666; }
    .empty-icon { font-size: 4rem; margin-bottom: 20px; }
    .loading { text-align: center; padding: 60px; color: #666; }
    .spinner { width: 40px; height: 40px; border: 4px solid #eee; border-top-color: #FF9800; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 8px; z-index: 200; opacity: 0; transition: opacity 0.3s; }
    .toast.show { opacity: 1; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; text-align: center; }
    .modal-content h3 { margin-bottom: 15px; }
    .modal-content p { color: #666; margin-bottom: 20px; font-size: 0.9rem; }
    .modal-btns { display: flex; gap: 10px; }
    .modal-btns .btn { flex: 1; }
    @media (max-width: 480px) { .grid { grid-template-columns: repeat(3, 1fr); gap: 8px; } .cover-preview { justify-content: center; } }
  </style>
</head>
<body>
  <div class="header" id="header">
    <h1>ğŸ“¤ LINE è²¼åœ–ä¸Šæ¶æº–å‚™</h1>
    <div class="progress-info">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <span class="count" id="countText">0 / 40</span>
    </div>
  </div>

  <div class="container">
    <div id="content">
      <div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div>
    </div>
  </div>

  <div class="actions">
    <div class="actions-inner">
      <p class="hint" id="hintText">ğŸ‘† é»æ“Šä»»ä¸€å¼µè²¼åœ–è¨­ç‚ºå°é¢åœ–ç‰‡</p>
      <div class="btn-row">
        <button class="btn btn-danger" onclick="showClearModal()">ğŸ—‘ï¸ æ¸…ç©º</button>
        <button class="btn btn-primary" id="downloadBtn" disabled onclick="download()">ğŸ“¥ ä¸‹è¼‰ LINE è²¼åœ–åŒ…</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- æ¸…ç©ºç¢ºèªå½ˆçª— -->
  <div class="modal" id="clearModal">
    <div class="modal-content">
      <h3>ğŸ—‘ï¸ ç¢ºå®šæ¸…ç©ºï¼Ÿ</h3>
      <p>å°‡ç§»é™¤æ‰€æœ‰ 40 å¼µè²¼åœ–ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
      <div class="modal-btns">
        <button class="btn btn-secondary" onclick="hideModal()">å–æ¶ˆ</button>
        <button class="btn btn-danger" onclick="clearAll()">ç¢ºå®šæ¸…ç©º</button>
      </div>
    </div>
  </div>

  <!-- ä¸‹è¼‰ä¸­å½ˆçª— -->
  <div class="modal" id="downloadModal">
    <div class="modal-content">
      <div class="spinner"></div>
      <h3>ğŸ“¦ æ­£åœ¨æ‰“åŒ…...</h3>
      <p>æ­£åœ¨è™•ç† 40 å¼µè²¼åœ–ï¼Œè«‹ç¨å€™ç´„ 1-2 åˆ†é˜...</p>
    </div>
  </div>

  <script>
    const API_BASE = '/.netlify/functions';
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');
    let queue = [];
    let selectedCoverIndex = 0;

    async function loadQueue() {
      if (!userId) { showEmpty('è«‹å¾ LINE é–‹å•Ÿæ­¤é é¢'); return; }
      try {
        const res = await fetch(`${API_BASE}/get-upload-queue?userId=${encodeURIComponent(userId)}`);
        const data = await res.json();
        if (data.success) { queue = data.queue || []; renderQueue(); }
        else { showEmpty('è¼‰å…¥å¤±æ•—ï¼š' + (data.error || 'æœªçŸ¥éŒ¯èª¤')); }
      } catch (e) { showEmpty('è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡è©¦'); }
    }

    function renderQueue() {
      const count = queue.length;
      const isReady = count >= 40;
      document.getElementById('header').className = 'header' + (isReady ? ' ready' : '');
      document.getElementById('countText').textContent = `${count} / 40`;
      document.getElementById('progressFill').style.width = `${(count/40)*100}%`;
      document.getElementById('downloadBtn').disabled = !isReady;
      document.getElementById('hintText').textContent = isReady
        ? 'âœ… å·²æ»¿ 40 å¼µï¼é»æ“Šè²¼åœ–è¨­ç‚ºå°é¢ï¼Œç„¶å¾Œä¸‹è¼‰'
        : `â³ é‚„éœ€è¦ ${40-count} å¼µè²¼åœ–`;

      if (count === 0) { showEmpty('ä½‡åˆ—æ˜¯ç©ºçš„ï¼Œè«‹å…ˆåœ¨ LINE ä¸­é¸æ“‡è²¼åœ–'); return; }

      // å°é¢é è¦½å€
      let html = '';
      if (isReady) {
        const cover = queue[selectedCoverIndex];
        html += `<div class="cover-section">
          <div class="section-title">ğŸ“¸ å°é¢é è¦½ï¼ˆLINE è¦æ ¼ï¼‰</div>
          <div class="cover-preview">
            <div class="cover-box">
              <img src="${cover.image_url}" width="120" height="120" style="object-fit:contain;">
              <p>ä¸»è¦åœ–ç‰‡ 240Ã—240</p>
            </div>
            <div class="cover-box">
              <img src="${cover.image_url}" width="96" height="74" style="object-fit:contain;">
              <p>æ¨™ç±¤åœ–ç‰‡ 96Ã—74</p>
            </div>
            <div style="flex:1;font-size:0.85rem;color:#666;">
              <p><strong>å°é¢ï¼š</strong>${cover.expression || 'è²¼åœ– '+(selectedCoverIndex+1)}</p>
              <p style="margin-top:5px;">é»æ“Šä¸‹æ–¹ä»»ä¸€å¼µè²¼åœ–å¯æ›´æ›å°é¢</p>
            </div>
          </div>
        </div>`;
      }

      html += '<div class="section-title">ğŸ–¼ï¸ è²¼åœ–åˆ—è¡¨ï¼ˆ40å¼µï¼‰</div>';
      html += '<div class="grid">';
      queue.forEach((item, i) => {
        const isSelected = i === selectedCoverIndex;
        html += `<div class="sticker-card${isSelected ? ' selected' : ''}" onclick="selectCover(${i})">
          <img class="sticker-img" src="${item.image_url}" alt="è²¼åœ– ${i+1}">
          <div class="sticker-info">
            <div class="sticker-name">${item.expression || 'è²¼åœ–'}</div>
            <div class="sticker-num">#${String(i+1).padStart(2,'0')}</div>
          </div>
        </div>`;
      });
      html += '</div>';
      document.getElementById('content').innerHTML = html;
    }

    function selectCover(index) {
      selectedCoverIndex = index;
      renderQueue();
      showToast(`å·²é¸æ“‡ #${index+1} ç‚ºå°é¢`);
    }

    function showEmpty(msg) {
      document.getElementById('content').innerHTML = `<div class="empty"><div class="empty-icon">ğŸ“‹</div><p>${msg}</p></div>`;
    }

    function showClearModal() {
      document.getElementById('clearModal').classList.add('show');
    }

    function hideModal() {
      document.getElementById('clearModal').classList.remove('show');
    }

    async function clearAll() {
      hideModal();
      try {
        const res = await fetch(`${API_BASE}/clear-queue`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });
        const data = await res.json();
        if (data.success) { queue = []; selectedCoverIndex = 0; renderQueue(); showToast('å·²æ¸…ç©º'); }
        else { showToast('æ¸…ç©ºå¤±æ•—'); }
      } catch (e) { showToast('æ“ä½œå¤±æ•—'); }
    }

    async function download() {
      document.getElementById('downloadModal').classList.add('show');

      try {
        const url = `${API_BASE}/pack-for-line?userId=${encodeURIComponent(userId)}&mainIndex=${selectedCoverIndex}`;

        // ä½¿ç”¨ fetch ä¸‹è¼‰
        const res = await fetch(url);
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'ä¸‹è¼‰å¤±æ•—');
        }

        // å–å¾— blob ä¸¦ä¸‹è¼‰
        const blob = await res.blob();
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = 'line_stickers.zip';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(downloadUrl);

        document.getElementById('downloadModal').classList.remove('show');
        showToast('âœ… ä¸‹è¼‰å®Œæˆï¼');

        // é¡¯ç¤ºä¸Šå‚³æç¤º
        setTimeout(() => {
          if (confirm('ä¸‹è¼‰å®Œæˆï¼æ˜¯å¦å‰å¾€ LINE Creators Market ä¸Šå‚³è²¼åœ–ï¼Ÿ')) {
            window.open('https://creator.line.me/my/', '_blank');
          }
        }, 500);

      } catch (e) {
        document.getElementById('downloadModal').classList.remove('show');
        showToast('âŒ ' + e.message);
      }
    }

    function showToast(msg) {
      const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2000);
    }

    loadQueue();
  </script>
</body>
</html>

