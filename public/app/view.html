<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŸ¥çœ‹è²¼åœ–çµ„ - Sticker Tycoon</title>
  <link rel="stylesheet" href="app.css">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <style>
    .sticker-view {
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px 20px;
    }

    .sticker-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 30px;
    }

    .sticker-title {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .sticker-meta {
      display: flex;
      gap: 20px;
      color: var(--text-secondary);
    }

    .sticker-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .sticker-item {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .sticker-item:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-glow);
    }

    .sticker-item img {
      width: 100%;
      aspect-ratio: 1;
      object-fit: contain;
      background: white;
    }

    .sticker-item-info {
      padding: 10px;
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .sticker-actions {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .download-all-btn {
      background: var(--gradient-primary);
      color: white;
      padding: 15px 30px;
      border-radius: var(--radius-md);
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
    }

    .download-all-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-glow);
    }

    .line-guide {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 25px;
      margin-top: 40px;
    }

    .line-guide h3 {
      margin-bottom: 15px;
    }

    .line-guide ol {
      color: var(--text-secondary);
      padding-left: 20px;
    }

    .line-guide li {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- å°èˆªåˆ— -->
  <nav class="navbar">
    <div class="container">
      <a href="dashboard.html" class="navbar-brand">
        <span>ğŸ¨ Sticker Tycoon</span>
      </a>
      <div class="navbar-nav">
        <a href="dashboard.html" class="nav-link">æˆ‘çš„ä½œå“</a>
        <a href="create.html" class="nav-link">å‰µä½œè²¼åœ–</a>
        <div class="nav-user">
          <div class="nav-user-avatar" id="user-avatar">?</div>
          <span id="user-name">è¼‰å…¥ä¸­...</span>
          <span class="nav-user-credits">ğŸª™ <span id="user-credits">0</span></span>
        </div>
      </div>
    </div>
  </nav>

  <main class="sticker-view">
    <div id="content">
      <div class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </main>

  <script src="auth.js"></script>
  <script src="api.js"></script>
  <script>
    let currentUser = null;
    let stickerSet = null;

    document.addEventListener('DOMContentLoaded', async () => {
      currentUser = await window.StickerAuth.requireAuth();
      if (!currentUser) return;

      updateUserDisplay();

      // å–å¾—è²¼åœ–çµ„ ID
      const urlParams = new URLSearchParams(window.location.search);
      const setId = urlParams.get('id');

      if (!setId) {
        showError('ç¼ºå°‘è²¼åœ–çµ„ ID');
        return;
      }

      await loadStickerSet(setId);
    });

    function updateUserDisplay() {
      document.getElementById('user-name').textContent = currentUser.displayName || currentUser.email;
      document.getElementById('user-credits').textContent = currentUser.credits || 0;
      document.getElementById('user-avatar').textContent = 
        (currentUser.displayName || currentUser.email).charAt(0).toUpperCase();
    }

    async function loadStickerSet(setId) {
      try {
        const data = await window.StickerAPI.getStickerSetDetail(setId);
        stickerSet = data.stickerSet;
        const stickers = data.stickers || [];

        renderStickerSet(stickerSet, stickers);
      } catch (error) {
        showError(error.message);
      }
    }

    function renderStickerSet(set, stickers) {
      document.getElementById('content').innerHTML = `
        <div class="sticker-header">
          <div>
            <h1 class="sticker-title">${escapeHtml(set.name)}</h1>
            <div class="sticker-meta">
              <span>ğŸ¨ ${set.style || 'å¯æ„›é¢¨'}</span>
              <span>ğŸ“Š ${set.count} å¼µ</span>
              <span>${getStatusBadge(set.status)}</span>
              <span>ğŸ“… ${formatDate(set.createdAt)}</span>
            </div>
          </div>
          <div class="sticker-actions">
            <a href="/.netlify/functions/download-pack?setId=${set.setId}" 
               class="download-all-btn" target="_blank">
              ğŸ“¥ ä¸‹è¼‰å…¨éƒ¨
            </a>
            <a href="dashboard.html" class="btn btn-secondary">
              â† è¿”å›
            </a>
          </div>
        </div>

        <div class="sticker-grid">
          ${stickers.map((sticker, i) => `
            <div class="sticker-item">
              <img src="${sticker.imageUrl}" alt="${sticker.expression}" loading="lazy">
              <div class="sticker-item-info">
                #${sticker.index} ${sticker.expression}
              </div>
            </div>
          `).join('')}
        </div>

        <div class="line-guide">
          <h3>ğŸ“± å¦‚ä½•ä¸Šå‚³åˆ° LINE Creators Market</h3>
          <ol>
            <li>é»æ“Šã€Œä¸‹è¼‰å…¨éƒ¨ã€å–å¾—æ‰€æœ‰è²¼åœ– PNG æª”æ¡ˆ</li>
            <li>å‰å¾€ <a href="https://creator.line.me/" target="_blank" style="color: var(--primary);">LINE Creators Market</a> ç™»å…¥</li>
            <li>å»ºç«‹æ–°çš„è²¼åœ–å°ˆæ¡ˆ</li>
            <li>ä¸Šå‚³ä¸‹è¼‰çš„è²¼åœ–åœ–ç‰‡ï¼ˆéœ€ç¬¦åˆ 370Ã—320 px è¦æ ¼ï¼‰</li>
            <li>å¡«å¯«è²¼åœ–è³‡è¨Šä¸¦æäº¤å¯©æ ¸</li>
            <li>å¯©æ ¸é€šéå¾Œå³å¯ç™¼ä½ˆï¼</li>
          </ol>
          <p style="margin-top: 15px; color: var(--text-secondary);">
            ğŸ’¡ æç¤ºï¼šå¯ä½¿ç”¨ LINE Bot çš„ã€Œæ‰“åŒ…ä¸‹è¼‰ã€åŠŸèƒ½å–å¾—å·²èª¿æ•´å¥½å°ºå¯¸çš„è²¼åœ–
          </p>
        </div>
      `;
    }

    function getStatusBadge(status) {
      const badges = {
        completed: '<span class="status-badge status-completed">âœ… å®Œæˆ</span>',
        processing: '<span class="status-badge status-processing">â³ è™•ç†ä¸­</span>',
        generating: '<span class="status-badge status-processing">ğŸ¨ ç”Ÿæˆä¸­</span>',
        pending: '<span class="status-badge status-pending">â¸ï¸ ç­‰å¾…ä¸­</span>',
        failed: '<span class="status-badge status-failed">âŒ å¤±æ•—</span>'
      };
      return badges[status] || badges.pending;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('zh-TW', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function showError(message) {
      document.getElementById('content').innerHTML = `
        <div class="alert alert-error">
          âŒ ${message}
        </div>
        <a href="dashboard.html" class="btn btn-secondary">â† è¿”å›</a>
      `;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>

