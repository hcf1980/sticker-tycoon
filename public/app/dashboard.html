<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„å·¥ä½œå®¤ - Sticker Tycoon</title>
  <link rel="stylesheet" href="app.css">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
</head>
<body>
  <!-- å°èˆªåˆ— -->
  <nav class="navbar">
    <div class="container">
      <a href="dashboard.html" class="navbar-brand">
        <span>ğŸ¨ Sticker Tycoon</span>
      </a>
      <div class="navbar-nav">
        <a href="dashboard.html" class="nav-link active">æˆ‘çš„ä½œå“</a>
        <a href="create.html" class="nav-link">å‰µä½œè²¼åœ–</a>
        <div class="nav-user">
          <div class="nav-user-avatar" id="user-avatar">?</div>
          <span id="user-name">è¼‰å…¥ä¸­...</span>
          <span class="nav-user-credits">ğŸ« <span id="user-credits">0</span></span>
        </div>
        <button class="btn btn-sm btn-secondary" onclick="handleLogout()">ç™»å‡º</button>
      </div>
    </div>
  </nav>

  <!-- ä¸»è¦å…§å®¹ -->
  <main class="dashboard">
    <div class="container">
      <!-- æ¨™é¡Œ -->
      <div class="dashboard-header">
        <h1 class="dashboard-title">æˆ‘çš„å·¥ä½œå®¤</h1>
        <a href="create.html" class="btn btn-primary btn-lg">
          âœ¨ é–‹å§‹å‰µä½œ
        </a>
      </div>

      <!-- çµ±è¨ˆå¡ç‰‡ -->
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ«</div>
          <div class="stat-value" id="stat-credits">--</div>
          <div class="stat-label">å‰©é¤˜å¼µæ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ¨</div>
          <div class="stat-value" id="stat-sets">--</div>
          <div class="stat-label">è²¼åœ–çµ„æ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ–¼ï¸</div>
          <div class="stat-value" id="stat-stickers">--</div>
          <div class="stat-label">è²¼åœ–ç¸½æ•¸</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ”—</div>
          <div class="stat-value" id="stat-referrals">--</div>
          <div class="stat-label">æ¨è–¦äººæ•¸</div>
        </div>
      </div>

      <!-- å¼µæ•¸æç¤º -->
      <div class="alert alert-info" id="token-alert" style="display: none;">
        ğŸ’¡ éœ€è¦æ›´å¤šå¼µæ•¸ï¼Ÿè«‹é€é <a href="https://line.me/R/ti/p/@sticker-tycoon" target="_blank" style="color: var(--primary);">LINE Bot</a> è³¼è²·
      </div>

      <!-- è²¼åœ–çµ„åˆ—è¡¨ -->
      <h2 style="margin-bottom: 20px;">æˆ‘çš„è²¼åœ–çµ„</h2>
      
      <div id="sticker-sets-container">
        <div class="loading">
          <div class="loading-spinner"></div>
          <div class="loading-text">è¼‰å…¥ä¸­...</div>
        </div>
      </div>
    </div>
  </main>

  <script src="auth.js"></script>
  <script src="api.js"></script>
  <script>
    let currentUser = null;

    // é é¢è¼‰å…¥
    document.addEventListener('DOMContentLoaded', async () => {
      // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
      currentUser = await window.StickerAuth.requireAuth();
      if (!currentUser) return;

      // æ›´æ–°ç”¨æˆ¶è³‡è¨Š
      updateUserDisplay();

      // è¼‰å…¥è³‡æ–™
      await loadDashboardData();
    });

    function updateUserDisplay() {
      document.getElementById('user-name').textContent = currentUser.displayName || currentUser.email;
      document.getElementById('user-credits').textContent = currentUser.credits || 0;
      document.getElementById('user-avatar').textContent = 
        (currentUser.displayName || currentUser.email).charAt(0).toUpperCase();
    }

    async function loadDashboardData() {
      try {
        // è¼‰å…¥ç”¨æˆ¶è³‡æ–™
        const profileData = await window.StickerAPI.getUserProfile();
        if (profileData.user) {
          currentUser = profileData.user;
          updateUserDisplay();
          
          document.getElementById('stat-credits').textContent = profileData.user.credits || 0;
          document.getElementById('stat-referrals').textContent = profileData.user.referralCount || 0;

          // é¡¯ç¤ºå¼µæ•¸æç¤ºï¼ˆå¦‚æœé¤˜é¡ä½ï¼‰
          if (profileData.user.credits < 10) {
            document.getElementById('token-alert').style.display = 'flex';
          }
        }

        // è¼‰å…¥è²¼åœ–çµ„
        const setsData = await window.StickerAPI.getStickerSets(1, 50);
        
        document.getElementById('stat-sets').textContent = setsData.pagination?.total || 0;
        
        // è¨ˆç®—è²¼åœ–ç¸½æ•¸
        const totalStickers = setsData.stickerSets?.reduce((sum, set) => sum + (set.count || 0), 0) || 0;
        document.getElementById('stat-stickers').textContent = totalStickers;

        // æ¸²æŸ“è²¼åœ–çµ„
        renderStickerSets(setsData.stickerSets || []);

      } catch (error) {
        console.error('è¼‰å…¥å¤±æ•—:', error);
        document.getElementById('sticker-sets-container').innerHTML = `
          <div class="alert alert-error">
            è¼‰å…¥å¤±æ•—ï¼š${error.message}
          </div>
        `;
      }
    }

    function renderStickerSets(sets) {
      const container = document.getElementById('sticker-sets-container');

      if (sets.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ¨</div>
            <h3 class="empty-state-title">é‚„æ²’æœ‰è²¼åœ–ä½œå“</h3>
            <p class="empty-state-text">é–‹å§‹å‰µä½œæ‚¨çš„ç¬¬ä¸€çµ„ AI è²¼åœ–å§ï¼</p>
            <a href="create.html" class="btn btn-primary btn-lg">
              âœ¨ é–‹å§‹å‰µä½œ
            </a>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <div class="sticker-sets-grid">
          ${sets.map(set => `
            <div class="sticker-set-card animate-fadeIn">
              <div class="sticker-set-cover">
                ${set.coverUrl 
                  ? `<img src="${set.coverUrl}" alt="${set.name}" loading="lazy">`
                  : `<div class="placeholder">ğŸ–¼ï¸</div>`
                }
              </div>
              <div class="sticker-set-info">
                <h3 class="sticker-set-name">${escapeHtml(set.name)}</h3>
                <div class="sticker-set-meta">
                  <span>${getStatusBadge(set.status)}</span>
                  <span>ğŸ“Š ${set.count} å¼µ</span>
                  <span>ğŸ¨ ${set.style || 'å¯æ„›é¢¨'}</span>
                </div>
                <div class="sticker-set-actions">
                  ${set.status === 'completed' 
                    ? `<a href="view.html?id=${set.setId}" class="btn btn-primary btn-sm">æŸ¥çœ‹</a>`
                    : set.status === 'processing' || set.status === 'pending'
                    ? `<span class="status-badge status-processing animate-pulse">â³ ç”Ÿæˆä¸­...</span>`
                    : `<span class="status-badge status-failed">âŒ å¤±æ•—</span>`
                  }
                  <button class="btn btn-secondary btn-sm" onclick="deleteStickerSet('${set.setId}', '${escapeHtml(set.name)}')">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function getStatusBadge(status) {
      const badges = {
        completed: '<span class="status-badge status-completed">âœ… å®Œæˆ</span>',
        processing: '<span class="status-badge status-processing">â³ è™•ç†ä¸­</span>',
        generating: '<span class="status-badge status-processing">ğŸ¨ ç”Ÿæˆä¸­</span>',
        pending: '<span class="status-badge status-pending">â¸ï¸ ç­‰å¾…ä¸­</span>',
        failed: '<span class="status-badge status-failed">âŒ å¤±æ•—</span>'
      };
      return badges[status] || badges.pending;
    }

    async function deleteStickerSet(setId, name) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
        return;
      }

      try {
        await window.StickerAPI.deleteStickerSet(setId);
        alert('åˆªé™¤æˆåŠŸï¼');
        await loadDashboardData();
      } catch (error) {
        alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
      }
    }

    function handleLogout() {
      if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        window.StickerAuth.logout();
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>

